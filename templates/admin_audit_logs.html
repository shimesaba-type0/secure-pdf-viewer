{% extends "layout.html" %}

{% block title %}{{ title }} - Secure PDF Viewer{% endblock %}

{% block extra_css %}
<style>
/* ç›£æŸ»ãƒ­ã‚°åˆ†æç”»é¢å°‚ç”¨CSS */
.audit-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.audit-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e9ecef;
}

.audit-title {
    margin: 0;
    color: #2c3e50;
    font-size: 28px;
    font-weight: 600;
}

.audit-subtitle {
    color: #7f8c8d;
    font-size: 14px;
    margin-top: 5px;
}

/* çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ */
.stats-dashboard {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stats-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
    transition: transform 0.2s ease;
}

.stats-card:hover {
    transform: translateY(-5px);
}

.stats-number {
    display: block;
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 5px;
}

.stats-label {
    color: #666;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stats-card.low { color: #28a745; }
.stats-card.medium { color: #ffc107; }
.stats-card.high { color: #dc3545; }
.stats-card.critical { color: #6f42c1; }

/* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.filters-section {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 30px;
}

.filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.filter-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    color: #2c3e50;
}

.filter-group select,
.filter-group input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.filter-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    transition: background-color 0.2s ease;
}

.btn-primary {
    background-color: #007bff;
    color: white;
}

.btn-primary:hover {
    background-color: #0056b3;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background-color: #545b62;
}

.btn-success {
    background-color: #28a745;
    color: white;
}

.btn-success:hover {
    background-color: #1e7e34;
}

/* ã‚°ãƒ©ãƒ•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.charts-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.chart-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.chart-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 15px;
    color: #2c3e50;
}

.chart-container {
    position: relative;
    height: 300px;
}

/* ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.logs-section {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.logs-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 20px;
}

.logs-title {
    font-size: 20px;
    font-weight: 600;
    color: #2c3e50;
    margin: 0;
}

.table-responsive {
    overflow-x: auto;
}

.logs-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

.logs-table th,
.logs-table td {
    padding: 12px 10px;
    text-align: left;
    border-bottom: 1px solid #e9ecef;
}

.logs-table th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #2c3e50;
    position: sticky;
    top: 0;
    z-index: 10;
}

.logs-table tbody tr:hover {
    background-color: #f5f5f5;
}

.risk-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
}

.risk-low { background-color: #d4edda; color: #155724; }
.risk-medium { background-color: #fff3cd; color: #856404; }
.risk-high { background-color: #f8d7da; color: #721c24; }
.risk-critical { background-color: #e2d9f3; color: #432874; }

.success-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.success-true { background-color: #d4edda; color: #155724; }
.success-false { background-color: #f8d7da; color: #721c24; }

/* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ */
.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 5px;
    margin-top: 20px;
}

.pagination button {
    padding: 8px 12px;
    border: 1px solid #ddd;
    background: white;
    cursor: pointer;
    border-radius: 4px;
}

.pagination button:hover:not(:disabled) {
    background-color: #f8f9fa;
}

.pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.pagination .active {
    background-color: #007bff;
    color: white;
    border-color: #007bff;
}

/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
.loading {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px;
    color: #666;
}

.loading-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* ã‚¨ãƒ©ãƒ¼è¡¨ç¤º */
.error-message {
    background-color: #f8d7da;
    color: #721c24;
    padding: 15px;
    border-radius: 4px;
    margin: 20px 0;
    border-left: 4px solid #dc3545;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
@media (max-width: 768px) {
    .audit-container {
        padding: 10px;
    }
    
    .stats-dashboard {
        grid-template-columns: 1fr;
    }
    
    .filters-grid {
        grid-template-columns: 1fr;
    }
    
    .charts-section {
        grid-template-columns: 1fr;
    }
    
    .filter-actions {
        justify-content: center;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ç›£æŸ»ãƒ­ã‚°åˆ†æJavaScript
class AuditLogAnalysis {
    constructor() {
        this.currentPage = 1;
        this.currentFilters = {};
        this.charts = {};
        
        this.init();
    }
    
    init() {
        // åˆæœŸçµ±è¨ˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        this.loadStats();
        
        // ã‚°ãƒ©ãƒ•åˆæœŸåŒ–
        this.initCharts();
        
        // ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿
        this.loadLogs();
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        this.setupEventListeners();
    }
    
    setupEventListeners() {
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ãƒœã‚¿ãƒ³
        document.getElementById('applyFilters')?.addEventListener('click', () => {
            this.applyFilters();
        });
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
        document.getElementById('resetFilters')?.addEventListener('click', () => {
            this.resetFilters();
        });
        
        // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³
        document.getElementById('exportCSV')?.addEventListener('click', () => {
            this.exportData('csv');
        });
        
        document.getElementById('exportJSON')?.addEventListener('click', () => {
            this.exportData('json');
        });
        
        // æœŸé–“é¸æŠå¤‰æ›´
        document.getElementById('periodSelect')?.addEventListener('change', (e) => {
            this.updatePeriod(e.target.value);
        });
    }
    
    async loadStats() {
        try {
            const response = await fetch('/admin/api/audit-logs/stats');
            if (!response.ok) throw new Error('çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            
            const stats = await response.json();
            this.updateStatsDisplay(stats);
            
        } catch (error) {
            console.error('çµ±è¨ˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            this.showError('çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    }
    
    updateStatsDisplay(stats) {
        console.log('Stats data:', stats); // ãƒ‡ãƒãƒƒã‚°ç”¨
        
        // çµ±è¨ˆã‚«ãƒ¼ãƒ‰ã®æ›´æ–°
        const totalElement = document.getElementById('totalActions');
        if (totalElement) {
            totalElement.textContent = stats.total_actions || stats.total || 0;
        }
        
        // stats.statsãŒé…åˆ—ã®å ´åˆã€ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«åˆ¥ã«é›†è¨ˆ
        let riskCounts = stats.risk_level_counts || {};
        if (stats.stats && Array.isArray(stats.stats)) {
            riskCounts = { low: 0, medium: 0, high: 0, critical: 0 };
            // å®Ÿéš›ã®é›†è¨ˆã¯ã‚µãƒ¼ãƒãƒ¼å´ã§è¡Œã†ã¹ãã§ã™ãŒã€ä¸€æ™‚çš„ãªå¯¾å¿œ
            stats.stats.forEach(item => {
                if (item.risk_level && riskCounts.hasOwnProperty(item.risk_level)) {
                    riskCounts[item.risk_level] += item.count || 1;
                }
            });
        }
        
        const riskElements = {
            'low': document.getElementById('lowRiskCount'),
            'medium': document.getElementById('mediumRiskCount'),
            'high': document.getElementById('highRiskCount'),
            'critical': document.getElementById('criticalRiskCount')
        };
        
        Object.entries(riskElements).forEach(([risk, element]) => {
            if (element) {
                element.textContent = riskCounts[risk] || 0;
            }
        });
    }
    
    initCharts() {
        // ç®¡ç†è€…åˆ¥æ´»å‹•çŠ¶æ³
        this.initAdminActivityChart();
        
        // ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«åˆ†å¸ƒ
        this.initRiskDistributionChart();
        
        // æ—¥åˆ¥æ´»å‹•æ¨ç§»
        this.initDailyActivityChart();
        
        // ãƒªã‚½ãƒ¼ã‚¹åˆ¥ã‚¢ã‚¯ã‚»ã‚¹
        this.initResourceAccessChart();
    }
    
    async initAdminActivityChart() {
        try {
            const response = await fetch('/admin/api/audit-logs/chart-data?type=admin_activity');
            const data = await response.json();
            console.log('Admin Activity Chart Data:', data); // ãƒ‡ãƒãƒƒã‚°ç”¨
            
            const ctx = document.getElementById('adminActivityChart');
            if (ctx) {
                this.charts.adminActivity = new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('ç®¡ç†è€…æ´»å‹•ã‚°ãƒ©ãƒ•ã‚¨ãƒ©ãƒ¼:', error);
        }
    }
    
    async initRiskDistributionChart() {
        try {
            const response = await fetch('/admin/api/audit-logs/chart-data?type=risk_trend');
            const data = await response.json();
            
            const ctx = document.getElementById('riskDistributionChart');
            if (ctx) {
                this.charts.riskDistribution = new Chart(ctx, {
                    type: 'pie',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('ãƒªã‚¹ã‚¯åˆ†å¸ƒã‚°ãƒ©ãƒ•ã‚¨ãƒ©ãƒ¼:', error);
        }
    }
    
    async initDailyActivityChart() {
        try {
            const response = await fetch('/admin/api/audit-logs/chart-data?type=daily_activity');
            const data = await response.json();
            
            const ctx = document.getElementById('dailyActivityChart');
            if (ctx) {
                this.charts.dailyActivity = new Chart(ctx, {
                    type: 'line',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('æ—¥åˆ¥æ´»å‹•ã‚°ãƒ©ãƒ•ã‚¨ãƒ©ãƒ¼:', error);
        }
    }
    
    async initResourceAccessChart() {
        try {
            const response = await fetch('/admin/api/audit-logs/chart-data?type=resource_access');
            const data = await response.json();
            
            const ctx = document.getElementById('resourceAccessChart');
            if (ctx) {
                this.charts.resourceAccess = new Chart(ctx, {
                    type: 'bar',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('ãƒªã‚½ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ã‚°ãƒ©ãƒ•ã‚¨ãƒ©ãƒ¼:', error);
        }
    }
    
    async loadLogs(page = 1) {
        try {
            this.showLoading();
            
            const params = new URLSearchParams({
                page: page,
                limit: 50,
                ...this.currentFilters
            });
            
            const response = await fetch(`/admin/api/audit-logs?${params}`);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ${response.status} ${errorText}`);
            }
            
            const data = await response.json();
            console.log('API Response:', data); // ãƒ‡ãƒãƒƒã‚°ç”¨
            
            // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ç¢ºèª
            if (data.error) {
                throw new Error(data.error);
            }
            
            // APIãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ã«å¿œã˜ãŸå‡¦ç†
            let actions, pagination;
            if (data.actions && typeof data.actions === 'object' && data.actions.actions) {
                // å…¥ã‚Œå­æ§‹é€ ã®å ´åˆ
                actions = data.actions.actions;
                pagination = {
                    page: data.actions.page || 1,
                    limit: data.actions.limit || 50,
                    total: data.actions.total || 0,
                    has_next: data.actions.actions.length >= data.actions.limit,
                    has_prev: data.actions.page > 1
                };
            } else {
                // é€šå¸¸æ§‹é€ ã®å ´åˆ
                actions = data.actions || data || [];
                pagination = data.pagination || {};
            }
            
            this.updateLogsTable(actions);
            this.updatePagination(pagination);
            
        } catch (error) {
            console.error('ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            this.showError('ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        } finally {
            this.hideLoading();
        }
    }
    
    updateLogsTable(actions) {
        const tbody = document.querySelector('#logsTable tbody');
        if (!tbody) return;
        
        // actionsãŒé…åˆ—ã§ãªã„å ´åˆã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        if (!Array.isArray(actions)) {
            console.error('Actions is not an array:', actions);
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼</td></tr>';
            return;
        }
        
        if (actions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
            return;
        }
        
        tbody.innerHTML = actions.map(action => `
            <tr onclick="showActionDetails(${action.id})" style="cursor: pointer;">
                <td>${action.id}</td>
                <td>${action.admin_email}</td>
                <td>${this.getActionTypeLabel(action.action_type)}</td>
                <td>${action.resource_type || ''}</td>
                <td>${action.created_at}</td>
                <td><span class="risk-badge risk-${action.risk_level}">${this.getRiskLevelLabel(action.risk_level)}</span></td>
                <td><span class="success-badge success-${action.success}">${action.success ? 'æˆåŠŸ' : 'å¤±æ•—'}</span></td>
                <td>${action.ip_address}</td>
            </tr>
        `).join('');
    }
    
    updatePagination(pagination) {
        const container = document.getElementById('pagination');
        if (!container) return;
        
        container.innerHTML = `
            <button ${!pagination.has_prev ? 'disabled' : ''} onclick="auditAnalysis.loadLogs(${pagination.page - 1})">
                â† å‰ã¸
            </button>
            <span>ãƒšãƒ¼ã‚¸ ${pagination.page} / ${Math.ceil(pagination.total / pagination.limit)}</span>
            <button ${!pagination.has_next ? 'disabled' : ''} onclick="auditAnalysis.loadLogs(${pagination.page + 1})">
                æ¬¡ã¸ â†’
            </button>
        `;
    }
    
    applyFilters() {
        this.currentFilters = {
            admin_email: document.getElementById('adminEmailFilter')?.value || '',
            action_type: document.getElementById('actionTypeFilter')?.value || '',
            resource_type: document.getElementById('resourceTypeFilter')?.value || '',
            risk_level: document.getElementById('riskLevelFilter')?.value || '',
            success: document.getElementById('successFilter')?.value || '',
            start_date: document.getElementById('startDateFilter')?.value || '',
            end_date: document.getElementById('endDateFilter')?.value || ''
        };
        
        // ç©ºã®å€¤ã‚’é™¤å»
        Object.keys(this.currentFilters).forEach(key => {
            if (!this.currentFilters[key]) {
                delete this.currentFilters[key];
            }
        });
        
        this.currentPage = 1;
        this.loadLogs(1);
    }
    
    resetFilters() {
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
        ['adminEmailFilter', 'actionTypeFilter', 'resourceTypeFilter', 
         'riskLevelFilter', 'successFilter', 'startDateFilter', 'endDateFilter'].forEach(id => {
            const element = document.getElementById(id);
            if (element) element.value = '';
        });
        
        this.currentFilters = {};
        this.currentPage = 1;
        this.loadLogs(1);
    }
    
    async exportData(format) {
        try {
            const params = new URLSearchParams({
                format: format,
                ...this.currentFilters
            });
            
            const response = await fetch(`/admin/api/audit-logs/export?${params}`);
            if (!response.ok) throw new Error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = response.headers.get('Content-Disposition')?.split('filename=')[1] || `audit_logs.${format}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
        } catch (error) {
            console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
            this.showError('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    }
    
    async updatePeriod(period) {
        await this.loadStats();
        // ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
        Object.values(this.charts).forEach(chart => {
            if (chart) chart.destroy();
        });
        this.charts = {};
        this.initCharts();
    }
    
    getActionTypeLabel(type) {
        const labels = {
            'admin_login': 'ãƒ­ã‚°ã‚¤ãƒ³',
            'admin_logout': 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
            'user_update': 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°',
            'setting_update': 'è¨­å®šå¤‰æ›´',
            'log_view': 'ãƒ­ã‚°é–²è¦§',
            'log_export': 'ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ'
        };
        return labels[type] || type;
    }
    
    getRiskLevelLabel(level) {
        const labels = {
            'low': 'ä½',
            'medium': 'ä¸­',
            'high': 'é«˜',
            'critical': 'é‡è¦'
        };
        return labels[level] || level;
    }
    
    showLoading() {
        const loading = document.getElementById('loading');
        if (loading) loading.style.display = 'block';
    }
    
    hideLoading() {
        const loading = document.getElementById('loading');
        if (loading) loading.style.display = 'none';
    }
    
    showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = message;
        
        const container = document.querySelector('.audit-container');
        if (container) {
            container.insertBefore(errorDiv, container.firstChild);
            
            // 5ç§’å¾Œã«å‰Šé™¤
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }
    }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
async function showActionDetails(actionId) {
    try {
        const response = await fetch(`/admin/api/audit-logs/action-details/${actionId}`);
        if (!response.ok) throw new Error('è©³ç´°æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        
        const details = await response.json();
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã¾ãŸã¯è©³ç´°è¡¨ç¤ºã®å®Ÿè£…
        alert(`æ“ä½œè©³ç´°:\nç®¡ç†è€…: ${details.admin_email}\næ“ä½œ: ${details.action_type}\næ™‚åˆ»: ${details.created_at}\næˆåŠŸ: ${details.success ? 'ã¯ã„' : 'ã„ã„ãˆ'}`);
        
    } catch (error) {
        console.error('è©³ç´°è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
    }
}

// åˆæœŸåŒ–
let auditAnalysis;
document.addEventListener('DOMContentLoaded', () => {
    auditAnalysis = new AuditLogAnalysis();
});
</script>
{% endblock %}

{% block content %}
<div class="audit-container">
    <div class="audit-header">
        <div>
            <h1 class="audit-title">{{ title }}</h1>
            <p class="audit-subtitle">ç®¡ç†è€…æ“ä½œã®è©³ç´°åˆ†æãƒ»çµ±è¨ˆãƒ»ç›£æŸ»ãƒ¬ãƒãƒ¼ãƒˆ</p>
        </div>
    </div>
    
    {% if error %}
    <div class="error-message">
        {{ error }}
    </div>
    {% endif %}
    
    <!-- çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
    <div class="stats-dashboard">
        <div class="stats-card">
            <span class="stats-number" id="totalActions">-</span>
            <span class="stats-label">ç·æ“ä½œæ•°</span>
        </div>
        <div class="stats-card low">
            <span class="stats-number" id="lowRiskCount">-</span>
            <span class="stats-label">ä½ãƒªã‚¹ã‚¯æ“ä½œ</span>
        </div>
        <div class="stats-card medium">
            <span class="stats-number" id="mediumRiskCount">-</span>
            <span class="stats-label">ä¸­ãƒªã‚¹ã‚¯æ“ä½œ</span>
        </div>
        <div class="stats-card high">
            <span class="stats-number" id="highRiskCount">-</span>
            <span class="stats-label">é«˜ãƒªã‚¹ã‚¯æ“ä½œ</span>
        </div>
        <div class="stats-card critical">
            <span class="stats-number" id="criticalRiskCount">-</span>
            <span class="stats-label">é‡è¦æ“ä½œ</span>
        </div>
    </div>
    
    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»æ¤œç´¢ -->
    <div class="filters-section">
        <h3>æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h3>
        <div class="filters-grid">
            <div class="filter-group">
                <label for="adminEmailFilter">ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«</label>
                <input type="email" id="adminEmailFilter" placeholder="admin@example.com">
            </div>
            <div class="filter-group">
                <label for="actionTypeFilter">æ“ä½œç¨®åˆ¥</label>
                <select id="actionTypeFilter">
                    <option value="">ã™ã¹ã¦</option>
                    <option value="admin_login">ãƒ­ã‚°ã‚¤ãƒ³</option>
                    <option value="admin_logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</option>
                    <option value="user_update">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°</option>
                    <option value="setting_update">è¨­å®šå¤‰æ›´</option>
                    <option value="log_view">ãƒ­ã‚°é–²è¦§</option>
                    <option value="log_export">ãƒ­ã‚°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="resourceTypeFilter">ãƒªã‚½ãƒ¼ã‚¹ç¨®åˆ¥</label>
                <select id="resourceTypeFilter">
                    <option value="">ã™ã¹ã¦</option>
                    <option value="user">ãƒ¦ãƒ¼ã‚¶ãƒ¼</option>
                    <option value="setting">è¨­å®š</option>
                    <option value="admin_actions">ç›£æŸ»ãƒ­ã‚°</option>
                    <option value="session">ã‚»ãƒƒã‚·ãƒ§ãƒ³</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="riskLevelFilter">ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«</label>
                <select id="riskLevelFilter">
                    <option value="">ã™ã¹ã¦</option>
                    <option value="low">ä½ãƒªã‚¹ã‚¯</option>
                    <option value="medium">ä¸­ãƒªã‚¹ã‚¯</option>
                    <option value="high">é«˜ãƒªã‚¹ã‚¯</option>
                    <option value="critical">é‡è¦</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="successFilter">æˆåŠŸ/å¤±æ•—</label>
                <select id="successFilter">
                    <option value="">ã™ã¹ã¦</option>
                    <option value="true">æˆåŠŸ</option>
                    <option value="false">å¤±æ•—</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="startDateFilter">é–‹å§‹æ—¥æ™‚</label>
                <input type="datetime-local" id="startDateFilter">
            </div>
            <div class="filter-group">
                <label for="endDateFilter">çµ‚äº†æ—¥æ™‚</label>
                <input type="datetime-local" id="endDateFilter">
            </div>
        </div>
        <div class="filter-actions">
            <button type="button" class="btn btn-primary" id="applyFilters">
                ğŸ” æ¤œç´¢
            </button>
            <button type="button" class="btn btn-secondary" id="resetFilters">
                ğŸ”„ ãƒªã‚»ãƒƒãƒˆ
            </button>
            <button type="button" class="btn btn-success" id="exportCSV">
                ğŸ“Š CSVå‡ºåŠ›
            </button>
            <button type="button" class="btn btn-success" id="exportJSON">
                ğŸ“„ JSONå‡ºåŠ›
            </button>
        </div>
    </div>
    
    <!-- ã‚°ãƒ©ãƒ•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="charts-section">
        <div class="chart-card">
            <h3 class="chart-title">ç®¡ç†è€…åˆ¥æ´»å‹•çŠ¶æ³</h3>
            <div class="chart-container">
                <canvas id="adminActivityChart"></canvas>
            </div>
        </div>
        
        <div class="chart-card">
            <h3 class="chart-title">ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«åˆ†å¸ƒ</h3>
            <div class="chart-container">
                <canvas id="riskDistributionChart"></canvas>
            </div>
        </div>
        
        <div class="chart-card">
            <h3 class="chart-title">æ—¥åˆ¥æ´»å‹•æ¨ç§»</h3>
            <div class="chart-container">
                <canvas id="dailyActivityChart"></canvas>
            </div>
        </div>
        
        <div class="chart-card">
            <h3 class="chart-title">ãƒªã‚½ãƒ¼ã‚¹åˆ¥ã‚¢ã‚¯ã‚»ã‚¹</h3>
            <div class="chart-container">
                <canvas id="resourceAccessChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div class="logs-section">
        <div class="logs-header">
            <h3 class="logs-title">ç›£æŸ»ãƒ­ã‚°è©³ç´°</h3>
        </div>
        
        <div id="loading" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            èª­ã¿è¾¼ã¿ä¸­...
        </div>
        
        <div class="table-responsive">
            <table class="logs-table" id="logsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ç®¡ç†è€…</th>
                        <th>æ“ä½œç¨®åˆ¥</th>
                        <th>ãƒªã‚½ãƒ¼ã‚¹</th>
                        <th>å®Ÿè¡Œæ—¥æ™‚</th>
                        <th>ãƒªã‚¹ã‚¯</th>
                        <th>çµæœ</th>
                        <th>IPã‚¢ãƒ‰ãƒ¬ã‚¹</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
        
        <div id="pagination" class="pagination">
            <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
        </div>
    </div>
</div>
{% endblock %}