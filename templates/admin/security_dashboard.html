{% extends "layout.html" %}

{% block title %}ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - Secure PDF Viewer{% endblock %}

{% block extra_css %}
    <style>
        .security-card {
            border-left: 4px solid #007bff;
            margin-bottom: 20px;
        }
        .security-card.alert-critical {
            border-left-color: #dc3545;
        }
        .security-card.alert-high {
            border-left-color: #fd7e14;
        }
        .security-card.alert-medium {
            border-left-color: #ffc107;
        }
        .security-card.status-ok {
            border-left-color: #28a745;
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .risk-score {
            font-size: 3rem;
            font-weight: bold;
        }
        .risk-score.low {
            color: #28a745;
        }
        .risk-score.medium {
            color: #ffc107;
        }
        .risk-score.high {
            color: #fd7e14;
        }
        .risk-score.critical {
            color: #dc3545;
        }
        .alert-item {
            border-left: 4px solid #6c757d;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f8f9fa;
        }
        .alert-item.critical {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        .alert-item.high {
            border-left-color: #fd7e14;
            background-color: #fff3cd;
        }
        .alert-item.medium {
            border-left-color: #ffc107;
            background-color: #fff3cd;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,.3);
            border-radius: 50%;
            border-top-color: #007bff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .refresh-btn {
            cursor: pointer;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-indicator.ok { background-color: #28a745; }
        .status-indicator.warning { background-color: #ffc107; }
        .status-indicator.error { background-color: #dc3545; }
        
        /* è©³ç´°æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .bg-danger-light {
            background-color: #f8d7da !important;
            color: #721c24 !important;
            padding: 0.5rem !important;
            border-radius: 0.25rem !important;
        }
        .bg-light {
            background-color: #f8f9fa !important;
            padding: 0.5rem !important;
            border-radius: 0.25rem !important;
        }
        
        /* ç®¡ç†è€…è©³ç´°æƒ…å ±ã®ãƒœãƒ¼ãƒ€ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ« */
        .border-success {
            border: 2px solid #28a745 !important;
        }
        .border-warning {
            border: 2px solid #ffc107 !important;
        }
        
        /* è©³ç´°æƒ…å ±ã‚«ãƒ¼ãƒ‰å†…ã®çµ±è¨ˆè¡¨ç¤º */
        #integrity-details h6 {
            font-size: 1.2rem !important;
            font-weight: bold !important;
            margin-bottom: 0.25rem !important;
        }
        
        #anomaly-details .border {
            border-width: 2px !important;
        }
        
        /* è©³ç´°æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ«å¼·åŒ– */
        #anomaly-details, #integrity-details {
            min-height: 100px;
        }
        
        .rounded {
            border-radius: 0.375rem !important;
        }
        
        .p-2 {
            padding: 0.5rem !important;
        }
        
        .mb-2 {
            margin-bottom: 0.5rem !important;
        }
        
        /* ãƒ­ã‚°å®Œå…¨æ€§è©³ç´°ã®æ”¹è‰¯ã‚¹ã‚¿ã‚¤ãƒ« */
        .stat-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1rem 0.5rem;
            transition: all 0.2s ease;
        }
        .stat-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .stat-box.stat-success {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        .stat-box.stat-danger {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
        .stat-box.stat-warning {
            background: #fff3cd;
            border-color: #ffeaa7;
        }
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            line-height: 1;
        }
        .stat-label {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        .integrity-progress {
            background: #f8f9fa;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        .progress-label {
            font-weight: 500;
            color: #495057;
        }
        .progress-percentage {
            font-weight: bold;
        }
        .alert-sm {
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .g-2 > * {
            padding-left: 0.25rem;
            padding-right: 0.25rem;
        }
        
        /* ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ã®æ”¹è‰¯ã‚¹ã‚¿ã‚¤ãƒ« */
        .stat-box.stat-info {
            background: #d1ecf1;
            border-color: #bee5eb;
        }
        .alert-card {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 0.75rem;
            transition: all 0.2s ease;
            border-left: 4px solid #6c757d;
        }
        .alert-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        .alert-card[data-severity="critical"] {
            border-left-color: #dc3545;
            background: linear-gradient(to right, #fff5f5, #fff);
        }
        .alert-card[data-severity="high"] {
            border-left-color: #fd7e14;
            background: linear-gradient(to right, #fffaf5, #fff);
        }
        .alert-card[data-severity="medium"] {
            border-left-color: #ffc107;
            background: linear-gradient(to right, #fffef5, #fff);
        }
        .severity-icon {
            font-size: 1.2rem;
            margin-right: 0.5rem;
        }
        .risk-badge {
            background: #f8f9fa;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.85rem;
        }
        .no-alerts-message {
            background: #f8f9fa;
            border-radius: 0.5rem;
            color: #6c757d;
        }
        
        /* æ‰‹å‹•ã‚¹ã‚­ãƒ£ãƒ³çµæœã®æ”¹è‰¯ã‚¹ã‚¿ã‚¤ãƒ« */
        .recommendations-box {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        .recommendation-list {
            margin-bottom: 0;
            padding-left: 1.25rem;
        }
        .recommendation-list li {
            margin-bottom: 0.25rem;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <a href="/admin" class="btn btn-secondary">
                                ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                            </a>
                            <button type="button" class="btn btn-secondary refresh-btn" onclick="refreshAllData()">
                                ğŸ”„ æ›´æ–°
                            </button>
                            <button type="button" class="btn btn-primary" onclick="openAuditLogs()">
                                ğŸ“‹ ç›£æŸ»ãƒ­ã‚°
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–çŠ¶æ³ -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card security-card status-loading" id="anomaly-card">
                            <div class="card-body text-center">
                                <h6 class="card-title">ç•°å¸¸æ¤œå‡ºçŠ¶æ³</h6>
                                <div class="metric-value text-primary" id="anomaly-count">
                                    <span class="loading-spinner"></span>
                                </div>
                                <small class="text-muted">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¢ãƒ©ãƒ¼ãƒˆ</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card security-card status-loading" id="integrity-card">
                            <div class="card-body text-center">
                                <h6 class="card-title">ãƒ­ã‚°å®Œå…¨æ€§</h6>
                                <div class="metric-value text-success" id="integrity-percentage">
                                    <span class="loading-spinner"></span>
                                </div>
                                <small class="text-muted">å®Œå…¨æ€§ä¿æŒç‡</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card security-card status-loading" id="risk-card">
                            <div class="card-body text-center">
                                <h6 class="card-title">æœ€é«˜ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢</h6>
                                <div class="risk-score low" id="max-risk-score">
                                    <span class="loading-spinner"></span>
                                </div>
                                <small class="text-muted">éå»1æ™‚é–“</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card security-card status-loading" id="admin-count-card">
                            <div class="card-body text-center">
                                <h6 class="card-title">æ´»å‹•ä¸­ç®¡ç†è€…</h6>
                                <div class="metric-value text-info" id="active-admin-count">
                                    <span class="loading-spinner"></span>
                                </div>
                                <small class="text-muted">éå»1æ™‚é–“</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è©³ç´°æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="row">
                    <!-- ç®¡ç†è€…åˆ¥ç•°å¸¸æ¤œå‡º -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>ç®¡ç†è€…åˆ¥ç•°å¸¸æ¤œå‡º</h5>
                                <button class="btn btn-sm btn-secondary refresh-btn" onclick="loadAnomalyDetails()">
                                    ğŸ”„
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="anomaly-details">
                                    <div class="text-center">
                                        <span class="loading-spinner"></span> ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ãƒ­ã‚°å®Œå…¨æ€§è©³ç´° -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>ãƒ­ã‚°å®Œå…¨æ€§è©³ç´°</h5>
                                <div>
                                    <button class="btn btn-sm btn-primary" onclick="runIntegrityCheck()">
                                        âœ… æ¤œè¨¼å®Ÿè¡Œ
                                    </button>
                                    <button class="btn btn-sm btn-secondary refresh-btn" onclick="loadIntegrityDetails()">
                                        ğŸ”„
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="integrity-details">
                                    <div class="text-center">
                                        <span class="loading-spinner"></span> ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´</h5>
                                <div>
                                    <span class="badge bg-danger" id="critical-alert-count">0</span> Critical
                                    <span class="badge bg-warning" id="high-alert-count">0</span> High
                                    <span class="badge bg-info" id="medium-alert-count">0</span> Medium
                                    <button class="btn btn-sm btn-secondary refresh-btn ms-2" onclick="loadSecurityAlerts()">
                                        ğŸ”„
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="security-alerts">
                                    <div class="text-center">
                                        <span class="loading-spinner"></span> ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ‰‹å‹•ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œãƒ‘ãƒãƒ« -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>æ‰‹å‹•ç•°å¸¸æ¤œå‡ºã‚¹ã‚­ãƒ£ãƒ³</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="scan-admin-email" class="form-label">ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                    <input type="email" class="form-control" id="scan-admin-email" placeholder="admin@example.com">
                                </div>
                                <div class="mb-3">
                                    <label for="scan-timeframe" class="form-label">æ¤œæŸ»æ™‚é–“ç¯„å›²</label>
                                    <select class="form-select" id="scan-timeframe">
                                        <option value="3600">1æ™‚é–“</option>
                                        <option value="7200">2æ™‚é–“</option>
                                        <option value="21600">6æ™‚é–“</option>
                                        <option value="43200">12æ™‚é–“</option>
                                        <option value="86400">24æ™‚é–“</option>
                                    </select>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="send-alerts">
                                    <label class="form-check-label" for="send-alerts">
                                        ç•°å¸¸æ¤œå‡ºæ™‚ã«ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡
                                    </label>
                                </div>
                                <button type="button" class="btn btn-primary" onclick="runManualScan()">
                                    ğŸ” ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ
                                </button>
                                <div id="scan-results" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-2">
                                    <span class="status-indicator ok"></span>
                                    <strong>ã‚·ã‚¹ãƒ†ãƒ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£:</strong> 
                                    <span class="badge bg-success">æ­£å¸¸</span>
                                </div>
                                <div class="mb-2">
                                    <span class="status-indicator" id="anomaly-status-indicator"></span>
                                    <strong>ç•°å¸¸æ¤œå‡º:</strong> 
                                    <span id="anomaly-status-text">ç¢ºèªä¸­...</span>
                                </div>
                                <div class="mb-2">
                                    <span class="status-indicator" id="integrity-status-indicator"></span>
                                    <strong>ãƒ­ã‚°å®Œå…¨æ€§:</strong> 
                                    <span id="integrity-status-text">ç¢ºèªä¸­...</span>
                                </div>
                                <div class="mb-2">
                                    <span class="status-indicator ok"></span>
                                    <strong>ç®¡ç†è€…èªè¨¼:</strong> 
                                    <span class="badge bg-success">æ­£å¸¸</span>
                                </div>
                                <hr>
                                <small class="text-muted">
                                    æœ€çµ‚æ›´æ–°: <span id="last-update-time">--:--:--</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block extra_js %}
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let refreshInterval;

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            refreshAllData();
            // 30ç§’é–“éš”ã§è‡ªå‹•æ›´æ–°
            refreshInterval = setInterval(refreshAllData, 30000);
        });

        // å…¨ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°
        function refreshAllData() {
            loadAnomalyStatus();
            loadIntegrityStatus();
            loadAnomalyDetails();
            loadIntegrityDetails();
            loadSecurityAlerts();
            document.getElementById('last-update-time').textContent = new Date().toLocaleTimeString();
        }

        // ç•°å¸¸æ¤œå‡ºçŠ¶æ³ã®èª­ã¿è¾¼ã¿
        async function loadAnomalyStatus() {
            try {
                const response = await fetch('/admin/api/security/anomaly-status');
                const data = await response.json();
                
                if (data.success) {
                    const { summary, total_admins, anomalous_admins } = data;
                    
                    // ç•°å¸¸æ¤œå‡ºæ•°ã®æ›´æ–°
                    document.getElementById('anomaly-count').textContent = anomalous_admins;
                    const anomalyCard = document.getElementById('anomaly-card');
                    anomalyCard.className = 'card security-card ' + (anomalous_admins > 0 ? 'alert-high' : 'status-ok');
                    
                    // æ´»å‹•ä¸­ç®¡ç†è€…æ•°ã®æ›´æ–°
                    document.getElementById('active-admin-count').textContent = total_admins;
                    
                    // æœ€é«˜ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢ã®æ›´æ–°
                    const maxRisk = Math.max(...summary.map(s => s.risk_score), 0);
                    const riskElement = document.getElementById('max-risk-score');
                    riskElement.textContent = maxRisk;
                    riskElement.className = 'risk-score ' + getRiskClass(maxRisk);
                    
                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                    updateAnomalyStatus(anomalous_admins > 0, anomalous_admins);
                }
            } catch (error) {
                console.error('ç•°å¸¸æ¤œå‡ºçŠ¶æ³ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('anomaly-count').innerHTML = '<span style="color: #dc3545;">âš ï¸</span>';
            }
        }

        // ãƒ­ã‚°å®Œå…¨æ€§çŠ¶æ³ã®èª­ã¿è¾¼ã¿
        async function loadIntegrityStatus() {
            try {
                const response = await fetch('/admin/api/security/log-integrity');
                const data = await response.json();
                
                if (data.success) {
                    const { integrity_percentage, has_issues } = data.data;
                    
                    // å®Œå…¨æ€§ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã®æ›´æ–°
                    document.getElementById('integrity-percentage').textContent = integrity_percentage.toFixed(1) + '%';
                    const integrityCard = document.getElementById('integrity-card');
                    integrityCard.className = 'card security-card ' + (has_issues ? 'alert-medium' : 'status-ok');
                    
                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
                    updateIntegrityStatus(has_issues, integrity_percentage);
                }
            } catch (error) {
                console.error('ãƒ­ã‚°å®Œå…¨æ€§çŠ¶æ³ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('integrity-percentage').innerHTML = '<span style="color: #dc3545;">âš ï¸</span>';
            }
        }

        // ç®¡ç†è€…åˆ¥ç•°å¸¸æ¤œå‡ºè©³ç´°ã®èª­ã¿è¾¼ã¿
        async function loadAnomalyDetails() {
            try {
                const response = await fetch('/admin/api/security/anomaly-status');
                const data = await response.json();
                
                if (data.success) {
                    let html = '';
                    
                    if (data.summary.length === 0) {
                        html = '<p class="text-muted">æ´»å‹•ä¸­ã®ç®¡ç†è€…ãŒã„ã¾ã›ã‚“</p>';
                    } else {
                        data.summary.forEach(admin => {
                            const statusClass = admin.anomalies_detected ? 'border-warning' : 'border-success';
                            html += `
                                <div class="border ${statusClass} p-2 mb-2 rounded">
                                    <div class="d-flex justify-content-between">
                                        <strong>${admin.admin_email}</strong>
                                        <span class="badge ${admin.anomalies_detected ? 'bg-warning' : 'bg-success'}">
                                            ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢: ${admin.risk_score}
                                        </span>
                                    </div>
                                    ${admin.anomalies_detected ? 
                                        `<small class="text-warning">${admin.anomaly_count}ä»¶ã®ç•°å¸¸ã‚’æ¤œå‡º</small>` :
                                        '<small class="text-success">ç•°å¸¸ãªã—</small>'
                                    }
                                </div>
                            `;
                        });
                    }
                    
                    document.getElementById('anomaly-details').innerHTML = html;
                }
            } catch (error) {
                console.error('ç•°å¸¸æ¤œå‡ºè©³ç´°ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('anomaly-details').innerHTML = '<p class="text-danger">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            }
        }

        // ãƒ­ã‚°å®Œå…¨æ€§è©³ç´°ã®èª­ã¿è¾¼ã¿
        async function loadIntegrityDetails() {
            try {
                const response = await fetch('/admin/api/security/log-integrity');
                const data = await response.json();
                
                if (data.success) {
                    const result = data.data;
                    const integrityPercentage = result.total_logs > 0 ? ((result.valid_logs / result.total_logs) * 100) : 100;
                    
                    const html = `
                        <!-- å®Œå…¨æ€§ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
                        <div class="integrity-summary mb-3">
                            <div class="row g-2">
                                <div class="col-3">
                                    <div class="stat-box text-center">
                                        <div class="stat-number">${result.total_logs}</div>
                                        <div class="stat-label">ğŸ“Š ç·ãƒ­ã‚°æ•°</div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="stat-box text-center stat-success">
                                        <div class="stat-number">${result.valid_logs}</div>
                                        <div class="stat-label">âœ… æœ‰åŠ¹ãƒ­ã‚°</div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="stat-box text-center ${result.invalid_logs > 0 ? 'stat-danger' : ''}">
                                        <div class="stat-number">${result.invalid_logs}</div>
                                        <div class="stat-label">âŒ ç„¡åŠ¹ãƒ­ã‚°</div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="stat-box text-center ${result.unverified_logs > 0 ? 'stat-warning' : ''}">
                                        <div class="stat-number">${result.unverified_logs}</div>
                                        <div class="stat-label">â³ æœªæ¤œè¨¼</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å®Œå…¨æ€§ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
                        <div class="integrity-progress mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="progress-label">ğŸ” ãƒ­ã‚°å®Œå…¨æ€§</span>
                                <span class="progress-percentage">${integrityPercentage.toFixed(1)}%</span>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar ${integrityPercentage >= 95 ? 'bg-success' : integrityPercentage >= 80 ? 'bg-warning' : 'bg-danger'}" 
                                     style="width: ${integrityPercentage}%"></div>
                            </div>
                        </div>
                        
                        <!-- ã‚¢ãƒ©ãƒ¼ãƒˆæƒ…å ± -->
                        ${result.tampered_log_ids.length > 0 ? 
                            `<div class="alert alert-danger alert-sm">
                                <div class="d-flex align-items-center">
                                    <span class="me-2">âš ï¸</span>
                                    <div>
                                        <strong>æ”¹ã–ã‚“æ¤œå‡º:</strong> ${result.tampered_log_ids.length}ä»¶<br>
                                        <small>ãƒ­ã‚°ID: ${result.tampered_log_ids.slice(0, 5).join(', ')}
                                        ${result.tampered_log_ids.length > 5 ? '...' : ''}</small>
                                    </div>
                                </div>
                            </div>` : ''
                        }
                        
                        ${result.unverified_logs > 0 ? 
                            `<div class="alert alert-info alert-sm">
                                <div class="d-flex align-items-center">
                                    <span class="me-2">â„¹ï¸</span>
                                    <small><strong>${result.unverified_logs}ä»¶</strong>ã®ãƒ­ã‚°ãŒãƒã‚§ãƒƒã‚¯ã‚µãƒ æœªè¨­å®šã§ã™</small>
                                </div>
                            </div>` : ''
                        }
                        
                        <!-- å‡¦ç†æ™‚é–“ -->
                        <div class="text-end">
                            <small class="text-muted">â±ï¸ æ¤œè¨¼æ™‚é–“: ${result.processing_time?.toFixed(2) || 0}ç§’</small>
                        </div>
                    `;
                    
                    document.getElementById('integrity-details').innerHTML = html;
                }
            } catch (error) {
                console.error('ãƒ­ã‚°å®Œå…¨æ€§è©³ç´°ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('integrity-details').innerHTML = '<p class="text-danger">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            }
        }

        // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ã®èª­ã¿è¾¼ã¿
        async function loadSecurityAlerts() {
            try {
                const response = await fetch('/admin/api/security/alerts');
                const data = await response.json();
                
                if (data.success) {
                    // çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
                    document.getElementById('critical-alert-count').textContent = data.stats.critical_alerts;
                    document.getElementById('high-alert-count').textContent = data.stats.high_alerts;
                    document.getElementById('medium-alert-count').textContent = data.stats.medium_alerts;
                    
                    // ã‚¢ãƒ©ãƒ¼ãƒˆçµ±è¨ˆã®è¡¨ç¤º
                    const totalAlerts = data.stats.critical_alerts + data.stats.high_alerts + data.stats.medium_alerts;
                    let html = `
                        <!-- ã‚¢ãƒ©ãƒ¼ãƒˆçµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
                        <div class="alert-summary mb-3">
                            <div class="row g-2">
                                <div class="col-3">
                                    <div class="stat-box text-center">
                                        <div class="stat-number">${totalAlerts}</div>
                                        <div class="stat-label">ğŸš¨ ç·ã‚¢ãƒ©ãƒ¼ãƒˆ</div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="stat-box text-center ${data.stats.critical_alerts > 0 ? 'stat-danger' : ''}">
                                        <div class="stat-number">${data.stats.critical_alerts}</div>
                                        <div class="stat-label">ğŸ”´ Critical</div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="stat-box text-center ${data.stats.high_alerts > 0 ? 'stat-warning' : ''}">
                                        <div class="stat-number">${data.stats.high_alerts}</div>
                                        <div class="stat-label">ğŸŸ¡ High</div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="stat-box text-center ${data.stats.medium_alerts > 0 ? 'stat-info' : ''}">
                                        <div class="stat-number">${data.stats.medium_alerts}</div>
                                        <div class="stat-label">ğŸ”µ Medium</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ã‚¢ãƒ©ãƒ¼ãƒˆä¸€è¦§ -->
                        <div class="alerts-list">
                    `;
                    
                    if (data.alerts.length === 0) {
                        html += `
                            <div class="no-alerts-message">
                                <div class="text-center p-4">
                                    <div class="mb-3">âœ…</div>
                                    <p class="text-muted mb-0">éå»24æ™‚é–“ã«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>
                                </div>
                            </div>
                        `;
                    } else {
                        data.alerts.slice(0, 10).forEach((alert, index) => {
                            const severityIcon = alert.severity === 'critical' ? 'ğŸš¨' : 
                                               alert.severity === 'high' ? 'âš ï¸' : 
                                               alert.severity === 'medium' ? 'â„¹ï¸' : 'ğŸ“';
                            html += `
                                <div class="alert-card mb-2" data-severity="${alert.severity}">
                                    <div class="alert-card-header">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div class="alert-title">
                                                <span class="severity-icon">${severityIcon}</span>
                                                <strong>${alert.admin_email}</strong>
                                                <span class="badge severity-badge bg-${getSeverityColor(alert.severity)}">${alert.severity.toUpperCase()}</span>
                                            </div>
                                            <small class="text-muted">${alert.timestamp}</small>
                                        </div>
                                    </div>
                                    <div class="alert-card-body">
                                        <div class="risk-info mb-2">
                                            <span class="risk-badge">ğŸ¯ ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢: <strong>${alert.risk_score}</strong></span>
                                        </div>
                                        <div class="anomaly-types mb-2">
                                            <small class="text-secondary">ğŸ” æ¤œå‡ºç•°å¸¸: ${alert.anomaly_types.join(', ')}</small>
                                        </div>
                                        <div class="alert-meta">
                                            <small class="text-muted">ID: ${alert.alert_id}</small>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        if (data.alerts.length > 10) {
                            html += `
                                <div class="text-center mt-3">
                                    <small class="text-muted">ä»–ã«${data.alerts.length - 10}ä»¶ã®ã‚¢ãƒ©ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã™</small>
                                </div>
                            `;
                        }
                    }
                    
                    html += '</div>';
                    
                    document.getElementById('security-alerts').innerHTML = html;
                }
            } catch (error) {
                console.error('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('security-alerts').innerHTML = '<p class="text-danger">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            }
        }

        // æ‰‹å‹•ã‚¹ã‚­ãƒ£ãƒ³ã®å®Ÿè¡Œ
        async function runManualScan() {
            const adminEmail = document.getElementById('scan-admin-email').value;
            const timeframe = parseInt(document.getElementById('scan-timeframe').value);
            const sendAlerts = document.getElementById('send-alerts').checked;
            
            if (!adminEmail) {
                alert('ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const resultsElement = document.getElementById('scan-results');
            resultsElement.innerHTML = '<div class="text-center"><span class="loading-spinner"></span> ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œä¸­...</div>';
            
            try {
                const response = await fetch('/admin/api/security/trigger-anomaly-scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        admin_email: adminEmail,
                        timeframe: timeframe,
                        send_alerts: sendAlerts
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const result = data.anomaly_result;
                    const riskClass = result.risk_score >= 80 ? 'stat-danger' : 
                                    result.risk_score >= 60 ? 'stat-warning' :
                                    result.risk_score >= 40 ? 'stat-info' : 'stat-success';
                    
                    let html = `
                        <!-- ã‚¹ã‚­ãƒ£ãƒ³çµæœã‚µãƒãƒªãƒ¼ -->
                        <div class="scan-result-summary mb-3">
                            <div class="row g-2">
                                <div class="col-4">
                                    <div class="stat-box text-center ${riskClass}">
                                        <div class="stat-number">${result.risk_score}</div>
                                        <div class="stat-label">ğŸ¯ ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-box text-center ${result.anomalies_detected ? 'stat-danger' : 'stat-success'}">
                                        <div class="stat-number">${result.anomalies_detected ? 'âš ï¸' : 'âœ…'}</div>
                                        <div class="stat-label">ç•°å¸¸æ¤œå‡º</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="stat-box text-center">
                                        <div class="stat-number">${result.anomaly_types.length}</div>
                                        <div class="stat-label">ğŸ” æ¤œå‡ºæ•°</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- è©³ç´°çµæœ -->
                        <div class="scan-result-details">
                            ${result.anomaly_types.length > 0 ? 
                                `<div class="alert alert-warning alert-sm">
                                    <h6 class="mb-2">ğŸ” æ¤œå‡ºã•ã‚ŒãŸç•°å¸¸</h6>
                                    ${result.anomaly_types.map(type => `<span class="badge bg-warning me-1">${type}</span>`).join('')}
                                </div>` : 
                                `<div class="alert alert-success alert-sm">
                                    <div class="d-flex align-items-center">
                                        <span class="me-2">âœ…</span>
                                        <span><strong>ç•°å¸¸ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</strong></span>
                                    </div>
                                </div>`
                            }
                            
                            ${result.recommendations && result.recommendations.length > 0 ? 
                                `<div class="recommendations-box mt-3">
                                    <h6 class="mb-2">ğŸ’¡ æ¨å¥¨å¯¾å¿œ</h6>
                                    <ul class="recommendation-list">
                                        ${result.recommendations.map(r => `<li>${r}</li>`).join('')}
                                    </ul>
                                </div>` : ''
                            }
                        </div>
                    `;
                    
                    if (data.alert_result) {
                        html += `
                            <div class="alert-sent-box mt-3">
                                <div class="alert alert-info alert-sm">
                                    <div class="d-flex align-items-center">
                                        <span class="me-2">ğŸ“¢</span>
                                        <div>
                                            <strong>ã‚¢ãƒ©ãƒ¼ãƒˆé€ä¿¡å®Œäº†</strong><br>
                                            <small>ID: ${data.alert_result.alert_id} | é‡è¦åº¦: 
                                            <span class="badge bg-${getSeverityColor(data.alert_result.severity)}">${data.alert_result.severity.toUpperCase()}</span>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    resultsElement.innerHTML = html;
                } else {
                    resultsElement.innerHTML = `<div class="alert alert-danger">ã‚¨ãƒ©ãƒ¼: ${data.error}</div>`;
                }
            } catch (error) {
                console.error('æ‰‹å‹•ã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
                resultsElement.innerHTML = '<div class="alert alert-danger">ã‚¹ã‚­ãƒ£ãƒ³ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            }
        }

        // ãƒ­ã‚°å®Œå…¨æ€§æ¤œè¨¼ã®å®Ÿè¡Œ
        async function runIntegrityCheck() {
            if (!confirm('ãƒ­ã‚°å®Œå…¨æ€§æ¤œè¨¼ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿå¤§é‡ã®ãƒ­ã‚°ãŒã‚ã‚‹å ´åˆã€æ™‚é–“ãŒã‹ã‹ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch('/admin/api/security/integrity-check', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        batch_size: 1000,
                        add_missing_checksums: true
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('ãƒ­ã‚°å®Œå…¨æ€§æ¤œè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸ');
                    loadIntegrityStatus();
                    loadIntegrityDetails();
                } else {
                    alert('æ¤œè¨¼ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
                }
            } catch (error) {
                console.error('ãƒ­ã‚°å®Œå…¨æ€§æ¤œè¨¼å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
                alert('æ¤œè¨¼ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ç›£æŸ»ãƒ­ã‚°ç”»é¢ã‚’é–‹ã
        function openAuditLogs() {
            window.open('/admin/audit-logs', '_blank');
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function getRiskClass(riskScore) {
            if (riskScore >= 80) return 'critical';
            if (riskScore >= 60) return 'high';
            if (riskScore >= 40) return 'medium';
            return 'low';
        }

        function getSeverityColor(severity) {
            switch(severity) {
                case 'critical': return 'danger';
                case 'high': return 'warning';
                case 'medium': return 'info';
                default: return 'secondary';
            }
        }

        function updateAnomalyStatus(hasAnomalies, count) {
            const indicator = document.getElementById('anomaly-status-indicator');
            const text = document.getElementById('anomaly-status-text');
            
            if (hasAnomalies) {
                indicator.className = 'status-indicator error';
                text.innerHTML = `<span class="badge bg-danger">${count}ä»¶ã®ç•°å¸¸ã‚’æ¤œå‡º</span>`;
            } else {
                indicator.className = 'status-indicator ok';
                text.innerHTML = '<span class="badge bg-success">ç•°å¸¸ãªã—</span>';
            }
        }

        function updateIntegrityStatus(hasIssues, percentage) {
            const indicator = document.getElementById('integrity-status-indicator');
            const text = document.getElementById('integrity-status-text');
            
            if (hasIssues || percentage < 95) {
                indicator.className = 'status-indicator warning';
                text.innerHTML = `<span class="badge bg-warning">${percentage.toFixed(1)}%</span>`;
            } else {
                indicator.className = 'status-indicator ok';
                text.innerHTML = `<span class="badge bg-success">${percentage.toFixed(1)}%</span>`;
            }
        }

        // ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹éš›ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
{% endblock %}