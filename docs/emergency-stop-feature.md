# 緊急停止機能仕様書

**作成日**: 2025-07-23  
**対象タスク**: TASK-003-10  
**実装状況**: ✅ 完了

## 概要

管理画面のクイックアクションから実行可能な緊急停止機能。全PDF公開停止と全セッション無効化を一括で実行し、システム全体を安全に停止する機能。

## 機能仕様

### 1. アクセス方法
- **URL**: 管理画面 (`/admin`) のクイックアクション部分
- **ボタン**: 「⚠️ 緊急停止」（赤色、btn-danger）
- **説明文**: 「全PDF公開停止 + 全セッション無効化を実行」

### 2. 実行フロー

#### 2.1 確認段階（2段階確認）
1. **第1段階確認**
   ```
   ⚠️ 緊急停止を実行しますか？
   
   実行内容：
   ✗ 全PDF公開を即座に停止
   ✗ 全セッションを無効化
   
   全ユーザーは再度ログインが必要になります。
   ```

2. **第2段階確認（誤操作防止）**
   ```
   本当に緊急停止を実行する場合は、「緊急停止」と入力してください：
   ```

#### 2.2 実行段階
1. **視覚的フィードバック**
   - ボタン無効化・表示変更: 「⏳ 緊急停止実行中...」
   - 全画面オーバーレイ表示（赤背景、警告アイコン）

2. **機能実行**
   - Step 1: 全PDF公開停止 (`auto_unpublish_all_pdfs()`)
   - Step 2: 全セッション無効化 (`invalidate_all_sessions()`)
   - Step 3: SSE通知送信
   - Step 4: ログ記録

## API仕様

### エンドポイント
```
POST /admin/emergency-stop
```

### 認証
- セッション認証必須 (`session.get('authenticated')`)
- 未認証時: `401 Unauthorized`

### レスポンス

#### 成功時
```json
{
  "success": true,
  "message": "緊急停止が完了しました",
  "unpublished_pdfs": 2,
  "deleted_sessions": 5,
  "deleted_otps": 3,
  "timestamp": "2025-07-23 15:30:45 JST",
  "execution_time": 0.85
}
```

#### エラー時
```json
{
  "success": false,
  "error": "緊急停止の実行に失敗しました: エラー詳細"
}
```

#### 部分的エラー時
```json
{
  "success": true,
  "message": "緊急停止は実行されましたが、1件のエラーが発生しました",
  "unpublished_pdfs": 2,
  "deleted_sessions": 5,
  "deleted_otps": 3,
  "timestamp": "2025-07-23 15:30:45 JST",
  "errors": ["PDF公開停止でエラー: 詳細"],
  "execution_time": 1.20
}
```

## 実行される機能詳細

### 1. 全PDF公開停止
- **使用関数**: `auto_unpublish_all_pdfs()`
- **動作**: 
  - `pdf_files` テーブルの `is_published = TRUE` を `FALSE` に更新
  - `unpublished_date` に実行時刻を記録
  - `publish_end` 設定をクリア

### 2. 全セッション無効化
- **使用関数**: `invalidate_all_sessions()`
- **動作**:
  - `session_stats` テーブルの全レコード削除
  - `otp_tokens` テーブルの全レコード削除
  - 削除件数を記録・返却

### 3. SSE通知
- **イベント型**: `emergency_stop`
- **送信データ**:
  ```json
  {
    "type": "emergency_stop",
    "message": "🚨 緊急停止が実行されました - 全PDF公開停止・全セッション無効化",
    "unpublished_pdfs": N,
    "deleted_sessions": N,
    "deleted_otps": N,
    "timestamp": "2025-07-23 15:30:45 JST",
    "clear_session": true
  }
  ```

### 4. ログ記録
- **ファイル**: `instance/emergency_log.txt`
- **形式**: `EMERGENCY_STOP|timestamp|PDFs:N|Sessions:N|OTPs:N|Time:Ns|Errors:N`
- **例**: `EMERGENCY_STOP|2025-07-23 15:30:45 JST|PDFs:2|Sessions:5|OTPs:3|Time:0.85s`

## クライアント側処理

### JavaScript関数
- **メイン関数**: `emergencyStop()`
- **SSEハンドラー**: `handleEmergencyStop(data)`

### 実行後の動作
1. 成功/エラーメッセージ表示
2. SSE通知による詳細情報表示
3. クライアント側セッションストレージクリア
4. 8秒後にページリロード

## セキュリティと安全性

### 誤操作防止
- 2段階確認システム
- テキスト入力による確認（「緊急停止」文字列）
- 視覚的に目立つ危険色の使用

### エラーハンドリング
- 各段階での個別エラーキャッチ
- 部分的失敗でも継続実行
- 詳細なエラーログ記録

### 既存機能の再利用
- 実績のある安定した関数を組み合わせ
- 新規実装リスクの最小化
- 一貫した動作の保証

## パフォーマンス

### 実行時間
- 想定実行時間: 0.5-2.0秒
- 実行時間の計測・記録
- タイムアウト設定なし（確実な実行を優先）

### リソース使用
- 軽量な既存関数の組み合わせ
- データベース操作は最小限
- メモリ使用量への影響は軽微

## 運用考慮事項

### 使用タイミング
- セキュリティインシデント発生時
- 不正アクセス検知時
- システムメンテナンス前
- 緊急事態全般

### 実行後の対応
1. ログファイルの確認
2. システム状態の確認
3. 必要に応じた再設定
4. ユーザーへの連絡

### 監視・アラート
- 実行ログの定期確認
- 異常な実行頻度の監視
- 実行失敗時のアラート設定（将来検討）

## 今後の拡張予定

### 機能強化
- データベースへのログ記録
- 実行理由の記録機能
- 自動復旧オプション
- メール通知機能

### 監視強化
- 実行頻度の監視
- 異常パターンの検知
- ダッシュボードでの実行履歴表示

---

**実装完了**: 2025-07-23  
**テスト状況**: 構文チェック・起動確認済み  
**次のステップ**: TASK-003-5（同時接続数制限・監視）