# ウォーターマーク機能強化実装ドキュメント

**実装日**: 2025-07-23  
**関連チケット**: [TASK-008](../tickets/tasks/TASK-008.md)  
**フェーズ**: Phase 2: セキュリティ強化

## 概要

スクリーンショット・カメラ撮影対策として、ウォーターマーク機能を強化し、複数箇所への分散配置による改ざん耐性とトレーサビリティを向上させる実装を行った。

## 実装内容

### 分散ウォーターマーク配置（5箇所）

1. **右上角ウォーターマーク**（既存強化）
   - 著作者名
   - 閲覧者メールアドレス
   - 日時
   - **セッションID上8桁**（新規追加、ラベルなし）

2. **左端中央ウォーターマーク**（新規）
   - 日時表示
   - 対角線角度（中央SIDと統一）
   - 透明度: 0.08
   - フォントサイズ: diagonalFontSize

3. **中央ウォーターマーク**（既存維持）
   - セッションID完全版
   - 対角線表示
   - 透明度: 0.08

4. **右端中央ウォーターマーク**（新規）
   - メールアドレス（@左側、30文字制限）
   - 対角線角度（中央SIDと統一）
   - 透明度: 0.08
   - フォントサイズ: diagonalFontSize

5. **下部中央ウォーターマーク**（既存維持）
   - ページ番号

### 技術仕様

#### フォント・スタイル統一
- **対角線ウォーターマーク**: Arial、bold、動的サイズ計算
- **透明度**: 0.08（対角線表示統一）
- **角度**: `Math.atan2(canvasHeight, canvasWidth)`で画面対角線角度統一
- **色**: #000000（黒）

#### メールアドレス最適化
- `@`マーク左側のみ表示
- 30文字制限（`substring(0, 30)`）
- 長いメールアドレスでも適切な表示サイズを維持

#### セッションID表示
- 中央: 完全版セッションID
- 右上: 上8桁のみ（識別性維持、ラベルなし）

## セキュリティ強化効果

### 改ざん耐性向上
- 5箇所への情報分散により、一部隠蔽されても他箇所から特定可能
- 右上角のウォーターマークが削除されても、対角線ウォーターマークで情報追跡可能

### トレーサビリティ強化
- セッションID: 2箇所（完全版・短縮版）
- メールアドレス: 2箇所（完全版・短縮版）
- 日時: 2箇所
- 複数の識別情報により確実な追跡が可能

## ファイル変更履歴

### 修正ファイル
- `static/js/pdf-viewer.js`: ウォーターマーク描画ロジック強化
  - `addWatermark()`メソッド: 755-810行目

### 主要変更点
1. 3箇所の対角線ウォーターマーク追加
2. 角度・濃度・フォントサイズの統一
3. メールアドレス表示最適化（30文字制限）
4. 右上角ウォーターマークにセッションID上8桁追加
5. 中央上部の冗長なセッションID表示削除

## 動作確認

### 確認項目
- [x] 5箇所すべてのウォーターマーク表示
- [x] 対角線角度の統一
- [x] フォントサイズ・濃度の統一
- [x] メールアドレス30文字制限の動作
- [x] セッションID上8桁の右上表示
- [x] 既存機能の維持

### 表示例
```
右上角:          左端中央:       中央:           右端中央:
著作者: [名前]    [日時]         [セッションID]   [メールローカル]
閲覧者: [メール]  (対角線)       (対角線)         (対角線)
日時: [日時]
[SID上8桁]
```

## 今後の検討課題

1. **改ざん検知機能**: ウォーターマーク改ざんの検知機能実装
2. **動的配置**: ランダムな位置配置でさらなる改ざん耐性向上
3. **暗号化**: ウォーターマーク情報の暗号化
4. **ログ機能**: ウォーターマーク表示履歴の記録

## 参考資料

- [TASK-008: スクリーンショット・カメラ撮影対策強化](../tickets/tasks/TASK-008.md)
- [Phase 2: セキュリティ強化](../tickets/phases/phase2-security.md)