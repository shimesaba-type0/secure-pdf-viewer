# TASK-003: セッション管理強化

**フェーズ**: [Phase 1: 認証システム完成](../phases/phase1-authentication.md)  
**優先度**: 🔴 高優先度  
**状況**: 🔄 部分実装  
**担当者**: TBD  
**作成日**: 2025-07-18

## 概要
セッション管理機能を強化し、セキュリティと運用性を向上させる。

## 要件
1. 72時間セッション有効期限の確実な実装
2. 強制ログアウト機能の拡張
3. セッション状態の可視化
4. 同時接続数制限

## 実装対象
- セッション管理機能の強化
- 管理画面でのセッション監視
- 全ユーザー強制ログアウト機能

## サブタスク

### 🔴 高優先度（フェーズ1完了必須）
- [x] **TASK-003-1**: 72時間セッション有効期限の確実な実装 ✅ 2025-07-20完了
  - セッション管理コードの確認・修正
  - 有効期限チェック機能の実装（`is_session_expired()`）
  - 自動ログアウト処理の実装（`require_valid_session()`）
  - バックグラウンドセッションクリーンアップ（毎時間実行）
  - 全保護ルート（/,/admin,APIエンドポイント）への適用
  - 包括的テストカバレッジ（5テスト、100%成功率）
- [x] **TASK-003-2**: セッション管理機能の設計変更 ✅ 2025-07-20完了
  - パスフレーズ変更時は管理者セッション継続に変更
  - 全セッション無効化機能を独立機能として実装
  - 設定時刻での定時全セッション無効化機能追加
- [ ] **TASK-003-7**: 全セッション無効化機能とスケジューラー実装
  - 独立した全セッション無効化関数の実装
  - 管理画面での実行時刻設定機能
  - 定時実行スケジューラーの実装
  - 手動実行ボタンの追加

### 🟡 中優先度（管理・監視機能）
- [ ] **TASK-003-3**: 管理画面でのアクティブセッション表示機能
  - セッション一覧表示画面
  - リアルタイム更新機能
  - セッション詳細情報表示
- [ ] **TASK-003-4**: 個別ユーザーのセッション終了機能
  - 個別セッション強制終了機能
  - セッション終了通知機能
- [ ] **TASK-003-5**: 同時接続数制限・監視機能（100セッション警告）
  - 同時接続数カウント機能
  - 接続数制限・警告機能
  - 監視ダッシュボード機能
- [ ] **TASK-003-6**: パスフレーズ入力フィールドのパスワードマネージャー対応改善
  - autocomplete属性の適切な設定でパスワードマネージャー認識向上
  - 長いパスフレーズでもパスワードマネージャーが確実に記憶するよう改善
  - 必要に応じてダミーユーザー名フィールド追加（パスワードマネージャー互換性向上）

## 成功条件
- [x] 72時間後の自動ログアウト ✅ 2025-07-20完了
- [x] セッション管理機能の設計変更 ✅ 2025-07-20完了
- [ ] 全セッション無効化機能とスケジューラー実装
- [ ] 管理画面でのアクティブセッション表示
- [ ] 個別ユーザーのセッション終了機能
- [ ] 同時接続数の制限・監視

## 技術的詳細
- **セッション有効期限**: 72時間（259200秒）
- **強制ログアウト**: セッション無効化
- **監視**: リアルタイムセッション数表示
- **制限**: 同時100セッション（警告）

## 実装完了詳細 ✅ 2025-07-20
### TASK-003-1: 72時間セッション有効期限機能
- **セッション有効期限チェック**: `is_session_expired()` 関数実装
  - 72時間（259200秒）の秒単位精度判定
  - 認証完了時刻からの経過時間計算
  - 設定値からの期限動的取得
- **自動ログアウト処理**: `require_valid_session()` 関数実装
  - 期限切れ時の事前共有パスフレーズ認証画面リダイレクト
  - セッションクリア・フラッシュメッセージ表示
- **保護ルートへの適用**: 全認証必須エンドポイントに実装
  - `/` (メインページ)
  - `/admin` (管理画面)
  - `/api/session-info` (セッション情報API)
  - `/api/events` (SSEストリーム)
- **バックグラウンドクリーンアップ**: `cleanup_expired_sessions()` 毎時間実行
  - 期限切れセッション統計の自動削除
  - 古いOTPトークン（24時間以上）の自動削除
- **包括的テストカバレッジ**: 5テストケース、100%成功率
  - 基本有効期限チェック機能
  - Webページリダイレクト動作
  - API応答での期限切れ処理
  - 有効セッションでの正常動作
  - カスタム有効期限設定対応

### コミット情報
- **コミットID**: `613f57f`
- **ブランチ**: `issue1`
- **ファイル変更**: `app.py` (+253行), `tests/test_auth_flow.py` (+137行)

## 見積もり
- **予想工数**: 1-2日 → **実績**: 1日
- **完了予定**: 2025年7月下旬 → **実際完了**: 2025年7月20日