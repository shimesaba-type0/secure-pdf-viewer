# TASK-021: 権限制御とセキュリティ強化

## 概要
管理者権限システムのセキュリティを強化し、権限制御を全システムに適用します。管理者と一般ユーザーの適切な分離を実現します。

## 背景・目的
- 管理画面への不正アクセス防止
- 権限昇格攻撃の防止
- セキュリティ監査の実現
- コンプライアンス要件への対応

## 要件

### セキュリティ要件
1. **アクセス制御**
   - 管理画面は管理者のみアクセス可能
   - API エンドポイントの権限チェック
   - 設定変更は管理者のみ可能

2. **セッション管理強化**
   - 管理者セッションの特別な管理
   - セッションハイジャック対策
   - 管理者ログアウト時の完全なセッション無効化

3. **監査ログ**
   - 管理者のすべての操作をログ記録
   - 権限変更の詳細ログ
   - 不正アクセス試行の記録

4. **多層防御**
   - IPアドレス制限（オプション）
   - 時間ベースのアクセス制御（オプション）
   - 管理者用の強化認証（将来拡張）

### 技術仕様

#### 権限チェック機能
```python
def is_admin(email):
    """メールアドレスが管理者かチェック"""
    
def require_admin(f):
    """管理者権限が必要なルートのデコレータ"""
    
def check_admin_session(session_id):
    """管理者セッションの有効性チェック"""
```

#### セキュリティログ強化
```python
def log_admin_action(admin_email, action, details, ip_address):
    """管理者操作のログ記録"""
    
def log_unauthorized_access(email, endpoint, ip_address):
    """不正アクセス試行のログ記録"""
```

#### 権限制御対象エンドポイント
1. **管理画面系**
   - `/admin/*` - 全ての管理画面
   - `/admin/api/*` - 管理API

2. **設定変更系**
   - 設定値の変更
   - システム状態の変更
   - ユーザー管理操作

3. **ログ閲覧系**
   - アクセスログ閲覧
   - セキュリティログ閲覧
   - セッション管理

### 実装項目

#### Phase 1: 基本権限制御
1. **権限チェック関数の実装**
   - `is_admin()` 関数
   - `require_admin` デコレータ
   - セッションベースの権限確認

2. **管理画面の保護**
   - 全管理画面ルートに権限チェック追加
   - 未認証時のリダイレクト処理
   - エラーページの実装

#### Phase 2: API セキュリティ
1. **管理API の保護**
   - 全管理APIに権限チェック
   - CSRF トークンの検証
   - レート制限の適用

2. **エラーレスポンスの統一**
   - 401 Unauthorized の適切な返却
   - 403 Forbidden の適切な返却
   - セキュリティ情報の非開示

#### Phase 3: 監査とログ
1. **操作ログの強化**
   - 管理者の全操作を記録
   - ログのタイムスタンプ統一
   - ログレベルの分類

2. **セキュリティイベント検知**
   - 不正アクセス試行の検知
   - 異常なパターンの検知
   - アラート機能（将来拡張）

### データベース拡張

#### admin_actions テーブル追加
```sql
CREATE TABLE admin_actions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    admin_email TEXT NOT NULL,
    action_type TEXT NOT NULL,
    resource_type TEXT,
    resource_id TEXT,
    details JSON,
    ip_address TEXT,
    user_agent TEXT,
    session_id TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    risk_level TEXT DEFAULT 'low'
);
```

#### セキュリティ設定追加
```sql
-- settings テーブルに追加
INSERT INTO settings (key, value, value_type, description, category) VALUES
('admin_session_timeout', '3600', 'integer', '管理者セッション有効期限（秒）', 'security'),
('admin_ip_restriction', '', 'string', '管理者アクセス許可IP（カンマ区切り）', 'security'),
('admin_audit_retention', '365', 'integer', '管理者監査ログ保持期間（日）', 'security');
```

### 成功基準
- [ ] 管理者のみが管理画面にアクセスできる
- [ ] 一般ユーザーは管理機能にアクセスできない
- [ ] 全ての管理者操作がログに記録される
- [ ] 不正アクセス試行が検知・記録される
- [ ] セッションが適切に管理される
- [ ] エラーハンドリングが適切に動作する
- [ ] 権限昇格攻撃が防止される

### セキュリティテスト項目
1. **権限制御テスト**
   - [ ] 管理者権限なしでの管理画面アクセス拒否
   - [ ] 権限昇格攻撃の防止
   - [ ] セッション固定攻撃の防止

2. **認証テスト**
   - [ ] 無効なセッションでのアクセス拒否
   - [ ] セッション有効期限の確認
   - [ ] 管理者ログアウト後のセッション無効化

3. **ログテスト**
   - [ ] 管理者操作のログ記録
   - [ ] 不正アクセス試行のログ記録
   - [ ] ログの改ざん防止

### パフォーマンス考慮事項
- 権限チェックのキャッシュ化
- データベースクエリの最適化
- ログ書き込みの非同期処理

## 実装ファイル
1. **auth/admin_auth.py** (新規)
   - 管理者権限チェック機能

2. **database/models.py**
   - 管理者関連のデータベース操作

3. **app.py**
   - ルートへの権限チェック適用

4. **security/audit_logger.py** (新規)
   - 監査ログ機能

## 関連チケット
- TASK-019: 管理者権限システムの実装
- TASK-020: 管理者権限フロントエンド実装

## 完了予定日
2025-07-30

## ステータス
- [x] 要件定義完了
- [ ] セキュリティ設計
- [ ] 実装開始
- [ ] セキュリティテスト
- [ ] 完了