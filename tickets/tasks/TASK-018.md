# TASK-018: アプリケーション内バックアップ・復旧システム

## 概要
管理画面からワンクリックでシステム全体のバックアップ・復旧を実行できる機能の実装

## 背景
現在のシステムは手動でのファイルコピーによるバックアップに依存しており、以下の課題があります：
- 管理者が手動でコマンド実行する必要がある
- SQLite実行中の安全でないファイルコピーのリスク
- バックアップファイルの管理が煩雑
- 定期バックアップの仕組みがない
- 復旧手順が明確でない

## 要件

### 機能要件

#### 1. バックアップ機能
**対象データ:**
- SQLiteデータベース (`instance/database.db`) - SQLite安全コマンド使用
- 設定ファイル (`.env`)
- アップロード済みPDFファイル (`static/pdfs/`)
- 重要ログファイル (`logs/app.log`, `instance/emergency_log.txt`)

**バックアップ方式:**
```python
# SQLite安全バックアップ
sqlite3 database.db ".backup backup_file.db"

# アーカイブ作成
tar.gz形式でまとめて圧縮
```

#### 2. 管理画面UI
**バックアップセクション:**
- 手動バックアップ実行ボタン
- バックアップ進行状況表示
- バックアップファイル一覧（作成日時、サイズ）
- ダウンロード機能
- 削除機能（世代管理）

**設定項目:**
- 自動バックアップ有効/無効
- バックアップ実行間隔（日次/週次）
- 保持世代数（デフォルト30日）
- バックアップ保存先パス

#### 3. 復旧機能（慎重実装）
- バックアップファイルからの復旧
- 復旧前の現在データ自動バックアップ
- 復旧実行確認（管理者認証）
- 復旧ログの記録

### 非機能要件

#### セキュリティ
- バックアップファイルの暗号化（オプション）
- アクセス制御（管理者のみ）
- バックアップファイルのパス traversal 対策
- 復旧時の整合性チェック

#### パフォーマンス
- バックアップ実行中のアプリケーション動作継続
- 大容量PDFファイル対応
- 非同期実行（進行状況表示）

#### 運用性
- バックアップ失敗時のアラート
- ディスク容量監視
- ログ出力（実行履歴）

## 実装方針

### Phase 1: 基本バックアップ機能
1. **バックアップコア機能**
   ```python
   # database/backup.py
   class BackupManager:
       def create_backup(self):
           # SQLite安全バックアップ
           # ファイル収集・アーカイブ化
           # メタデータ記録
   ```

2. **管理画面UI**
   - バックアップセクション追加
   - 手動実行ボタン
   - 進行状況表示（SSE使用）

### Phase 2: スケジューリング・世代管理
1. **定期実行機能**
   ```python
   # バックグラウンドタスク
   from apscheduler import BackgroundScheduler
   ```

2. **世代管理**
   - 古いバックアップ自動削除
   - 設定可能な保持期間

### Phase 3: 復旧機能
1. **復旧システム**
   - バックアップファイル検証
   - 段階的復旧プロセス
   - ロールバック機能

## 技術詳細

### ディレクトリ構造
```
backups/
├── manual/
│   ├── backup_20250730_143025.tar.gz
│   └── backup_20250730_120000.tar.gz
├── auto/
│   ├── daily_20250730.tar.gz
│   └── daily_20250729.tar.gz
└── metadata/
    ├── backup_20250730_143025.json
    └── daily_20250730.json
```

### バックアップアーカイブ構造
```
backup_20250730_143025/
├── database/
│   ├── database.db          # SQLite安全バックアップ
│   └── database_schema.sql  # スキーマ情報
├── config/
│   └── .env                 # 設定ファイル（秘匿情報マスク版）
├── files/
│   └── pdfs/                # PDFファイル
├── logs/
│   ├── app.log
│   └── emergency_log.txt
└── metadata.json            # バックアップ情報
```

### APIエンドポイント
```python
# 管理者用API
POST /admin/backup/create     # バックアップ実行
GET  /admin/backup/list       # バックアップ一覧
GET  /admin/backup/download   # ダウンロード
DELETE /admin/backup/delete   # 削除
POST /admin/backup/restore    # 復旧実行（Phase 3）
GET  /admin/backup/status     # 実行状況取得
```

## 実装対象ファイル

### 新規作成
- `database/backup.py` - バックアップコア機能
- `static/js/backup.js` - フロントエンド処理
- `templates/admin_backup.html` - 管理画面UI（または admin.html 拡張）

### 修正対象
- `app.py` - APIエンドポイント追加
- `templates/admin.html` - バックアップセクション追加
- `static/css/main.css` - スタイル追加

## 成功条件

### Phase 1
- [ ] 手動バックアップがワンクリックで実行できる
- [ ] SQLiteデータベースが安全にバックアップされる
- [ ] .env、PDFファイル、ログが含まれる
- [ ] tar.gz形式でアーカイブ化される
- [ ] バックアップファイル一覧が表示される
- [ ] バックアップファイルがダウンロードできる
- [ ] 進行状況がリアルタイム表示される

### Phase 2
- [ ] 定期バックアップが設定・実行される
- [ ] 世代管理（古いファイル自動削除）が動作する
- [ ] バックアップ設定が管理画面から変更できる

### Phase 3
- [ ] バックアップからの復旧が実行できる
- [ ] 復旧前の自動バックアップが作成される
- [ ] 復旧実行時の安全確認が動作する

## 優先度
**High** - 本番運用に必須の機能

## 見積もり工数
- **Phase 1**: 4-6時間（基本バックアップ機能）
- **Phase 2**: 2-3時間（スケジューリング・世代管理）
- **Phase 3**: 3-4時間（復旧機能）
- **合計**: 9-13時間

## 関連チケット
- TASK-001〜017: 全機能のデータ保護対象
- Phase 4 インフラ準備との連携

## セキュリティ考慮事項

### 機密情報の取り扱い
- `.env`ファイル内のパスワード・秘密鍵のマスク処理
- バックアップファイルのアクセス権限設定（600）
- バックアップディレクトリの外部アクセス防止

### 攻撃対策
- ファイル名のサニタイズ（Path Traversal対策）
- バックアップファイルサイズ制限
- 復旧時の整合性検証

## 備考
- 本機能により運用時のデータ保護が大幅に向上
- 災害復旧・移行作業が簡素化される
- Phase 4（本番環境構築）での必須要件
- 外部ストレージ連携（AWS S3等）は将来拡張として検討