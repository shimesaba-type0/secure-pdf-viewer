# TASK-022: 管理画面パスフレーズ変更フォームの表示ボタン修正とテスト強化

**フェーズ**: [Phase 2: セキュリティ強化](../phases/phase2-security.md)  
**優先度**: 🔴 高優先度  
**状況**: 🔄 進行中  
**担当者**: Claude  
**作成日**: 2025-08-13  

## 概要
管理画面のパスフレーズ変更フォームにおいて、パスワード表示/非表示切り替えボタンが機能しない問題を修正し、包括的なテストケースを実装する。

## 背景・問題点
### 発見された問題
- 管理画面（`/admin`）のパスフレーズ変更フォームで表示ボタンがクリックしても反応しない
- `togglePasswordVisibility()` 関数は実装されているがテストケースが存在しない
- 既存のテストでは検出できていない UI 機能の問題

### 影響
- 管理者のパスフレーズ変更時のUX（ユーザーエクスペリエンス）低下
- 長いパスフレーズの入力確認が困難
- テストされていない UI 機能による潜在的な品質問題

## 要件

### 機能要件
1. **表示ボタン機能の修復**
   - パスフレーズ入力フィールドの表示/非表示切り替えボタンを正常動作させる
   - 確認用パスフレーズフィールドの表示/非表示切り替えボタンも同様に修復

2. **UIフィードバックの改善**
   - ボタンテキストが「表示」⟷「隠す」で適切に切り替わる
   - aria-label属性による適切なアクセシビリティ対応

### 非機能要件
- 既存のCSS・HTMLデザインの保持
- レスポンシブデザインでの正常動作
- JavaScriptエラーの防止
- 包括的なテストカバレッジの確保

## 技術調査結果

### 現在の実装状況
- **HTMLテンプレート** (`templates/admin.html:186-202`): 
  ```html
  <button type="button" class="password-toggle-btn" id="toggleNewPassphrase" 
          onclick="togglePasswordVisibility('newPassphrase', this)">
      <span class="toggle-text">表示</span>
  </button>
  ```

- **JavaScript実装** (`static/js/admin.js:510-521`):
  ```javascript
  function togglePasswordVisibility(inputId, button) {
      console.log('togglePasswordVisibility called with:', inputId, button);
      // 実装は存在する
  }
  ```

### 推定される問題
1. JavaScript読み込みタイミングの問題
2. DOM要素の取得失敗
3. CSS競合による表示問題
4. イベントハンドラーのバインディング問題

## サブタスク

### 🔴 高優先度（即座修正）
- [ ] **TASK-022-1**: 表示ボタン機能の問題特定とデバッグ
  - ブラウザ開発者ツールでの詳細調査
  - コンソールエラー・DOM状態・イベント処理の確認
  - 根本原因の特定

- [ ] **TASK-022-2**: JavaScript実装の修正
  - `togglePasswordVisibility()` 関数の堅牢化
  - DOM要素取得エラーハンドリング強化
  - イベントハンドラーのバインディング改善

### 🟡 中優先度（テスト強化）
- [ ] **TASK-022-3**: 単体テストケース実装
  - パスワード表示切り替え機能のテスト
  - UI状態変更の確認テスト
  - アクセシビリティ属性のテスト

- [ ] **TASK-022-4**: 統合テスト・E2Eテスト実装
  - Seleniumによるブラウザ自動テスト
  - 実際のクリック操作とUI変更の検証
  - 複数ブラウザでの動作確認テスト

## 成功条件
- [ ] パスフレーズ変更フォームの表示ボタンが正常に動作
- [ ] 確認用パスフレーズフィールドの表示ボタンも正常に動作
- [ ] ボタンテキストが「表示」⟷「隠す」で正しく切り替わる
- [ ] JavaScriptエラーがコンソールに出力されない
- [ ] レスポンシブデザインでの動作確認
- [ ] 包括的なテストケース実装（5テスト以上）
- [ ] 全テストケースが100%成功

## 関連チケット
- [TASK-003-9: ログイン画面パスワード表示ボタン修正](./TASK-003.md#L93-L97) - 類似の表示ボタン修正例

## 見積もり
- **予想工数**: 0.5-1日
- **完了予定**: 2025年8月13日
- **優先度**: 高（管理者の日常業務に影響）

## 期待される効果
- 管理者のパスフレーズ変更時のUX向上
- 長いパスフレーズ入力時の確認作業効率化
- テストカバレッジの向上による品質保証
- 将来の類似問題の防止