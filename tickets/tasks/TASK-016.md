# TASK-016: タイムゾーン統一管理システム実装

**フェーズ**: [Phase 2: セキュリティ強化](../phases/phase2-security.md)  
**優先度**: 🟡 中優先度  
**状況**: 📋 計画中  
**担当者**: TBD  
**作成日**: 2025-07-26

## 概要
アプリケーション全体でタイムゾーンの不整合を解決し、環境変数による統一管理システムを実装する。

## 背景・問題点
現在のシステムでタイムゾーンの不整合が発生している：
- **データベース**: SQLiteの`CURRENT_TIMESTAMP` → UTC
- **アプリケーション**: `pytz.timezone('Asia/Tokyo')` → JST
- **utils.py**: `datetime.now()` → ローカルタイム（JST）

この不整合により、時刻比較やレート制限機能でバグが発生している。

## 要件

### 機能要件
1. 環境変数でタイムゾーンを統一管理
2. システム全体で一貫したタイムゾーン処理
3. 表示時の適切なタイムゾーン変換
4. 既存データの整合性維持

### 非機能要件
- 既存機能への影響最小化
- 設定変更時の柔軟性確保
- 国際展開への対応準備

## 実装対象

### 新規作成
- `config/timezone.py` - タイムゾーン統一管理モジュール
- `.env.example` へのタイムゾーン設定追加

### 修正対象
- `app.py` - JST定義とタイムゾーン処理（約10箇所）
- `database/utils.py` - 時刻比較ロジック（約5箇所）
- `database/models.py` - タイムスタンプ処理
- テストケース - 時刻関連テストの修正

## 技術設計

### 環境変数設定
```bash
# .env.example
TIMEZONE=Asia/Tokyo  # デフォルト値
# 本番環境では UTC に変更可能
```

### 共通タイムゾーンモジュール
```python
# config/timezone.py
import os
import pytz
from datetime import datetime

TIMEZONE = os.getenv('TIMEZONE', 'Asia/Tokyo')
APP_TZ = pytz.timezone(TIMEZONE)

def get_app_now():
    """アプリケーション統一タイムゾーンでの現在時刻"""
    return datetime.now(APP_TZ)

def get_app_datetime_string():
    """データベース保存用タイムゾーン統一文字列"""
    return get_app_now().strftime('%Y-%m-%d %H:%M:%S')
```

### データベース統一方針
- 保存時：設定タイムゾーンで統一
- 比較時：同一タイムゾーンベースで実行
- 表示時：必要に応じてタイムゾーン変換

## 成功条件
- [ ] 環境変数によるタイムゾーン設定
- [ ] システム全体でタイムゾーン統一
- [ ] 既存機能の正常動作確認
- [ ] レート制限テストの成功
- [ ] タイムゾーン変更テストの成功

## 影響範囲分析

### 変更規模
- **小〜中規模**: 約15-20ファイルの修正
- **工数**: 1-2日程度
- **テスト**: 既存時刻関連テストの修正

### リスク
- 既存データのタイムゾーン解釈変更
- 時刻依存機能での予期しない動作
- 本番環境でのタイムゾーン設定誤り

### 軽減策
- 段階的な実装とテスト
- 本番適用前の十分な検証
- ロールバック手順の準備

## 実装手順

### Phase 1: 基盤実装
1. `config/timezone.py` モジュール作成
2. `.env.example` 更新
3. 共通タイムゾーン関数の実装

### Phase 2: 段階的移行
1. `app.py` のタイムゾーン処理移行
2. `database/utils.py` の時刻比較修正
3. その他モジュールの順次対応

### Phase 3: テスト・検証
1. 単体テストの修正
2. 統合テストの実行
3. 異なるタイムゾーン設定でのテスト

## 見積もり
- **工数**: 1-2日
- **完了予定**: Phase 2 完了後

## 関連チケット
- [TASK-004: 詳細レート制限システム実装](./TASK-004.md) - タイムゾーン修正後にテスト実行
- セキュリティ関連の時刻依存機能全般

## 参考情報
- Python pytz ドキュメント
- SQLite タイムゾーン処理
- Django タイムゾーン設定パターン