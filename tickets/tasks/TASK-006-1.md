# TASK-006-1: セキュリティイベントログ出力機能実装

**親タスク**: [TASK-006: 詳細分析機能](TASK-006.md)  
**フェーズ**: [Phase 3: 監視・分析機能](../phases/phase3-monitoring.md)  
**優先度**: 🔴 高優先度  
**状況**: ✅ **完了**  
**担当者**: Claude Code  
**作成日**: 2025-07-29  
**完了日**: 2025-07-30  
**コミット**: `8b49798` (issue1)

## 概要
TASK-006の詳細分析機能を実現するための基盤として、資料の不正取得試行などのセキュリティイベントを検知・記録する機能を実装する。

## 要件
1. アクセスログの自動記録
2. セキュリティイベントログの自動記録
3. ログデータの構造化とデータベース永続化
4. 検知可能なイベントの実装
5. ログ保存期間管理（デフォルト90日）

## 実装対象
### 記録対象イベント
**実装容易（優先実装）**
- PDF表示・閲覧
- ダウンロード試行（右クリック、Ctrl+S等）
- 印刷試行（Ctrl+P、ブラウザメニュー）
- 直リンクアクセス（認証なしアクセス試行）
- 開発者ツール使用検知
- ページ離脱・戻る操作

**実装困難（検討対象）**
- スクリーンショット取得試行
- 画面録画検知
- OCRツール使用検知

## 成功条件
- [x] アクセスログ記録（IP、User Agent、メール、アクセス時刻、滞在時間）
- [x] セキュリティイベントログ記録（上記イベント種別）
- [x] access_logs テーブルの作成・運用
- [x] security_events テーブルの作成・運用
- [x] フロントエンドでのイベント検知機能
- [x] ログの一意性確保とパフォーマンス最適化
- [x] ログ自動削除機能（環境変数で保存期間設定可能）

## 技術的詳細
### データベーススキーマ
**access_logs テーブル**
- id (PRIMARY KEY)
- user_email (VARCHAR)
- ip_address (VARCHAR)
- user_agent (TEXT)
- accessed_at (TIMESTAMP)
- duration_seconds (INTEGER)
- pdf_file_path (VARCHAR)

**security_events テーブル**
- id (PRIMARY KEY)
- user_email (VARCHAR)
- event_type (ENUM: 'pdf_view', 'download_attempt', 'print_attempt', 'direct_access', 'devtools_open', 'unauthorized_action', 'page_leave')
- event_details (JSON)
- risk_level (ENUM: 'low', 'medium', 'high')
- ip_address (VARCHAR)
- user_agent (TEXT)
- occurred_at (TIMESTAMP)
- pdf_file_path (VARCHAR)

### 実装箇所
- データベースマイグレーション
- Express ミドルウェア（アクセスログ）
- フロントエンド JavaScript（イベント検知）
- ログ記録用API エンドポイント
- ログ記録用ユーティリティ関数
- ログクリーンアップ機能（cron job or 定期実行）

### 環境変数
- `LOG_RETENTION_DAYS`: ログ保存期間（デフォルト: 90日）
- `LOG_CLEANUP_INTERVAL`: クリーンアップ実行間隔（デフォルト: 毎日）

## 見積もり
- **工数**: 1.5-2日
- **完了予定**: 2025年7月31日

## 依存関係
- このタスクは TASK-006 の前提条件
- 完了後、TASK-006 の分析・可視化機能実装が可能になる