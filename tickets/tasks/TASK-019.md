# TASK-019: 管理者権限システムの実装

## 概要
システムに管理者権限機能を実装します。初期管理者は.envのADMIN_EMAILで設定し、その管理者が最大5人まで追加の管理者を設定できる仕組みを構築します。

## 背景・目的
- 管理画面へのアクセス制御が必要
- 設定変更権限の管理が必要
- セキュリティ上、管理者権限の適切な管理が重要

## 要件

### 基本要件
1. **初期管理者設定**
   - .envのADMIN_EMAILを一人目の管理者とする
   - システム初期化時に自動的に管理者テーブルに追加

2. **管理者追加機能**
   - 既存の管理者は最大5人まで追加の管理者を設定可能
   - メールアドレスとロールを紐づけ
   - 追加時に誰が追加したかを記録

3. **管理者管理機能**
   - 管理者一覧表示
   - 管理者の有効/無効切り替え
   - 管理者の削除（データベースから完全削除も可能）

4. **権限制御**
   - 管理者のみ管理画面アクセス可能
   - 管理者のみ全ての設定変更可能
   - 一般ユーザーは通常のPDF閲覧のみ

### 技術仕様

#### データベース
- **admin_users テーブル** (既存)
  ```sql
  CREATE TABLE admin_users (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      email TEXT UNIQUE,
      added_by TEXT,
      added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      is_active BOOLEAN DEFAULT TRUE
  );
  ```

#### 機能実装
1. **認証チェック関数**
   - `is_admin(email)`: メールアドレスが管理者かチェック
   - 管理画面の各ルートで権限チェック

2. **管理者管理API**
   - `GET /admin/users`: 管理者一覧取得
   - `POST /admin/users`: 新規管理者追加
   - `PUT /admin/users/<id>`: 管理者情報更新
   - `DELETE /admin/users/<id>`: 管理者削除

3. **フロントエンド**
   - 管理画面に「管理者管理」タブ追加
   - 管理者一覧表示
   - 管理者追加フォーム
   - 管理者削除確認ダイアログ

### 成功基準
- [ ] .envのADMIN_EMAILが初期管理者として自動設定される
- [ ] 管理者は管理画面にアクセスできる
- [ ] 一般ユーザーは管理画面にアクセスできない
- [ ] 管理者は新しい管理者を最大5人まで追加できる
- [ ] 管理者権限の有効/無効を切り替えできる
- [ ] 管理者を削除できる
- [ ] 管理者の追加/削除履歴が記録される

### セキュリティ考慮事項
- [ ] 管理者権限のないユーザーは管理画面にアクセス不可
- [ ] 管理者の最大数制限（6人まで：初期1人+追加5人）
- [ ] 管理者操作のログ記録
- [ ] セッション管理との連携

## 実装順序

### Phase 1: 基盤機能
1. 権限チェック関数の実装
2. 管理画面への権限制御追加
3. 初期管理者の自動設定機能

### Phase 2: 管理機能
1. 管理者管理APIの実装
2. 管理画面UIの実装
3. 管理者追加/削除機能

### Phase 3: セキュリティ強化
1. 操作ログの記録
2. エラーハンドリング
3. テストケースの作成

## 影響範囲
- `app.py`: 権限チェック機能追加
- `database/models.py`: 管理者関連関数追加
- `templates/admin.html`: 管理者管理UI追加
- `static/js/admin.js`: 管理者管理機能追加

## 注意事項
- 管理者権限の削除は慎重に実装（最後の管理者を削除できないようにする）
- .envのADMIN_EMAILが変更された場合の対応を検討
- 管理者権限の監査ログは必須

## 関連チケット
- 既存の管理画面機能との統合
- セッション管理機能との連携

## 完了予定日
2025-07-30

## ステータス
- [x] 要件定義完了
- [x] 実装完了（Phase 1-2）
- [x] 単体・統合テスト完了（23/23 tests passed）
- [x] CSS修正・UI改善完了
- [x] テストデータクリーンアップ機能追加
- [x] ブラウザ動作確認（シナリオ1-6全て完了）
- [x] 完了

## 実装完了内容

### ✅ 完了した実装
1. **設計書作成**: `docs/admin-permission-system-design.md`
2. **テストケース作成**: `tests/test_admin_permission.py` (23テスト、全て合格)
3. **Phase 1実装**: 権限チェック関数と初期管理者設定
   - `is_admin()` - メールアドレスによる管理者権限チェック
   - `require_admin_permission` - 管理者権限必須デコレータ
   - `setup_initial_admin()` - 初期管理者の自動設定
4. **Phase 2実装**: 管理者管理APIと管理画面UI
   - `GET /admin/users` - 管理者一覧取得API
   - `POST /admin/users` - 管理者追加API
   - `PUT /admin/users/<id>` - 管理者ステータス更新API
   - `DELETE /admin/users/<id>` - 管理者削除API
   - 管理者管理UIセクション（管理画面統合済み）
5. **コード品質チェック**: Black formatter、Flake8 linter
6. **データベース修正**:
   - `admin_users`テーブルに`updated_at`カラム追加
   - セキュリティイベントログ対応
7. **CSS改善**: 管理者一覧のスタイル統一、ステータス表示改善
8. **テストデータクリーンアップ**: `python tests/test_admin_permission.py --cleanup`

### 🛠️ 実装された機能詳細
- **権限システム**: セッション管理との統合、管理者権限チェック
- **管理者管理**: 追加・削除・ステータス更新（最大6人制限）
- **セキュリティ**: 最後の管理者削除防止、操作ログ記録
- **UI/UX**: レスポンシブデザイン、直感的な操作画面

### 🔧 解決済みの問題
- データベーススキーマの修正
- テスト環境でのデータベース分離
- タイムゾーン処理の修正
- メールアドレス不一致による権限エラー
- ステータス表示のCSS問題

## ブラウザ動作確認シナリオ

### テスト概要
以下の6つのシナリオを全て合格することで、管理者権限システムが正常に動作していることを確認できます。

### 前提条件
- アプリケーションが起動している
- ADMIN_EMAIL環境変数が設定されている（初期管理者用）
- ブラウザでアプリケーションにアクセス可能

### シナリオ1: 初期管理者設定の確認 ✅ 完了
**目的**: 環境変数による初期管理者が正しく設定されることを確認

**手順**:
1. アプリケーションを起動（ADMIN_EMAIL環境変数設定済み）
2. 初期管理者のメールアドレスでログイン
3. 管理画面(/admin)にアクセス
4. 管理者権限セクションが表示されることを確認

**合格基準**:
- [x] 初期管理者でログインできる
- [x] 管理画面にアクセスできる
- [x] 「管理者権限管理」セクションが表示される
- [x] 管理者一覧に初期管理者が表示される

**実施状況**: ✅ 完了
- 管理者一覧API（/admin/users）が正常動作
- 管理者権限チェックが正常動作
- UI表示・CSS修正完了

### シナリオ2: 権限チェック機能の確認 ✅ 完了
**目的**: 管理者権限がない場合のアクセス制御が正しく動作することを確認

**手順**:
1. 一般ユーザー（非管理者）でログイン
2. 管理画面(/admin)にアクセス
3. 管理者API(/admin/users)に直接アクセス（開発者ツール使用）

**合格基準**:
- [x] 一般ユーザーでは管理画面リンクが表示されない（ヘッダーから管理画面リンクが非表示）
- [x] 管理者APIへの直接アクセスで403エラーまたは適切なエラーメッセージが表示される
- [x] 適切なエラーページまたはメッセージが表示される（3秒後自動リダイレクト機能付き）

**実施状況**: ✅ 完了
- 無効化された管理者のアクセス制御バグを修正（/adminルートに@require_admin_permissionデコレータ追加）
- テンプレートでの管理者権限チェック機能を実装（is_admin_userコンテキスト変数）
- 権限のないユーザーには管理画面リンクを表示しない仕組みを実装
- 403エラーページに3秒後の自動リダイレクト機能と手動ボタンを追加

### シナリオ3: 管理者追加機能の確認
**目的**: 新規管理者の追加が正しく動作することを確認

**手順**:
1. 管理者権限を持つユーザーでログイン
2. 管理画面の管理者権限管理セクションにアクセス
3. 「新しい管理者を追加」フォームに有効なメールアドレスを入力
4. 「追加」ボタンをクリック
5. 管理者一覧が更新されることを確認
6. 追加した管理者でログインできることを確認

**合格基準**:
- [x] 管理者追加フォームが表示される
- [x] 有効なメールアドレスで管理者を追加できる
- [x] 追加後、管理者一覧に新しい管理者が表示される
- [x] 追加した管理者でログインして管理画面にアクセスできる
- [x] 無効なメールアドレスの場合、適切なエラーメッセージが表示される

**実施状況**: ✅ 完了
- 管理者追加機能が正常に動作することを確認
- showSuccessMessage/showErrorMessage関数を実装して削除機能も修正
- 無効化された管理者の物理削除機能を実装
- テーブルレイアウト（横スクロール対応、下線段差修正）を改善

### シナリオ4: 管理者ステータス更新機能の確認
**目的**: 管理者の有効/無効切り替えが正しく動作することを確認

**手順**:
1. 管理者権限を持つユーザーでログイン（複数の管理者が存在する状態）
2. 管理者一覧で他の管理者の「無効化」ボタンをクリック
3. ステータスが「無効」に変わることを確認
4. 無効化した管理者でログインを試行
5. 再度「有効化」ボタンをクリックしてステータスを戻す

**合格基準**:
- [x] 管理者ステータスを無効に変更できる
- [x] 無効化した管理者はログインしても管理画面にアクセスできない
- [x] ステータスを有効に戻すことができる
- [x] 最後の管理者は無効化できない（ボタンが無効化されるかエラーメッセージ）

**実施状況**: ✅ 完了
- 管理者ステータス更新機能が正常動作
- 無効化された管理者のアクセス制御が適切に動作（管理画面リンク非表示、/admin直接アクセスで403エラー）
- 有効化機能で管理者権限を復旧可能
- 最後の管理者無効化防止機能が動作（「管理者の更新に失敗しました（最後の管理者は無効化できません）」エラーメッセージ表示）

### シナリオ5: 管理者削除機能の確認
**目的**: 管理者の削除が正しく動作することを確認

**手順**:
1. 管理者権限を持つユーザーでログイン（複数の管理者が存在する状態）
2. 管理者一覧で他の管理者の「削除」ボタンをクリック
3. 確認ダイアログが表示されることを確認
4. 削除を実行
5. 管理者一覧から削除されることを確認
6. 最後の管理者を削除しようとする

**合格基準**:
- [x] 管理者を削除できる
- [x] 削除確認ダイアログが表示される
- [x] 削除後、管理者一覧から削除される
- [x] 削除した管理者はログインしても管理画面にアクセスできない
- [x] 最後の管理者は削除できない（ボタンが無効化されるかエラーメッセージ）

**実施状況**: ✅ 完了
- 2段階削除システムが正常動作（論理削除→物理削除）
- 論理削除: 管理者ステータスが無効化される
- 物理削除: データベースから完全削除され、管理者一覧から除去
- 削除された管理者のアクセス制御が適切に動作（管理画面アクセス不可）
- 最後の管理者削除防止機能が動作（「管理者の削除に失敗しました（最後の管理者は削除できません）」エラーメッセージ表示）

### シナリオ6: 管理者数制限の確認
**目的**: 管理者数の上限制限が正しく動作することを確認

**手順**:
1. 管理者権限を持つユーザーでログイン
2. 管理者を6人まで追加する
3. 7人目の管理者を追加しようとする
4. エラーメッセージが表示されることを確認

**合格基準**:
- [x] 6人まで管理者を追加できる
- [x] 7人目の追加時に適切なエラーメッセージが表示される
- [x] 管理者一覧に「6/6」のような表示がある

**実施状況**: ✅ 完了
- 管理者数上限制限（6人）が正常に動作
- 6人目まで管理者追加が成功
- 7人目追加時に「管理者を追加」ボタンが自動的に無効化される（UI制限）
- 上限に達した際の分かりやすいUI実装が確認された

### ブラウザテスト合格基準
**6つのシナリオ全てが合格した場合、ブラウザテストは合格となります。** ✅ **全シナリオ合格**

## 🎉 TASK-019 完了！

### ✅ 全ての要件が完了しました
- **Phase 1-2実装**: 権限チェック、初期管理者設定、管理者CRUD機能
- **単体・統合テスト**: 23/23 tests passed
- **ブラウザテスト**: 全6シナリオ完了
- **UI/UX**: CSS修正、レスポンシブデザイン対応
- **セキュリティ**: 最後の管理者削除防止、アクセス制御、管理者数制限

### 📊 最終確認結果
- **シナリオ1**: 初期管理者設定 ✅
- **シナリオ2**: 権限チェック機能 ✅
- **シナリオ3**: 管理者追加機能 ✅
- **シナリオ4**: ステータス更新機能 ✅
- **シナリオ5**: 管理者削除機能 ✅
- **シナリオ6**: 管理者数制限機能 ✅

### 🔧 実装された機能
1. **権限システム**: `.env`ベースの初期管理者設定、セッション連携
2. **管理者管理**: CRUD操作、最大6人制限、2段階削除
3. **セキュリティ**: アクセス制御、最後の管理者保護、操作ログ
4. **UI/UX**: 統合管理画面、直感的操作、エラーハンドリング

### 🚀 今後の改善案（別タスク）
- 管理者追加APIのパフォーマンス改善（現在6秒の応答時間）
- 管理者招待メール機能の追加
- 管理者操作の監査ログ強化