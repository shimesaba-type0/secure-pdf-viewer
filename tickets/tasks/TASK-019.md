# TASK-019: 管理者権限システムの実装

## 概要
システムに管理者権限機能を実装します。初期管理者は.envのADMIN_EMAILで設定し、その管理者が最大5人まで追加の管理者を設定できる仕組みを構築します。

## 背景・目的
- 管理画面へのアクセス制御が必要
- 設定変更権限の管理が必要
- セキュリティ上、管理者権限の適切な管理が重要

## 要件

### 基本要件
1. **初期管理者設定**
   - .envのADMIN_EMAILを一人目の管理者とする
   - システム初期化時に自動的に管理者テーブルに追加

2. **管理者追加機能**
   - 既存の管理者は最大5人まで追加の管理者を設定可能
   - メールアドレスとロールを紐づけ
   - 追加時に誰が追加したかを記録

3. **管理者管理機能**
   - 管理者一覧表示
   - 管理者の有効/無効切り替え
   - 管理者の削除（データベースから完全削除も可能）

4. **権限制御**
   - 管理者のみ管理画面アクセス可能
   - 管理者のみ全ての設定変更可能
   - 一般ユーザーは通常のPDF閲覧のみ

### 技術仕様

#### データベース
- **admin_users テーブル** (既存)
  ```sql
  CREATE TABLE admin_users (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      email TEXT UNIQUE,
      added_by TEXT,
      added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
      is_active BOOLEAN DEFAULT TRUE
  );
  ```

#### 機能実装
1. **認証チェック関数**
   - `is_admin(email)`: メールアドレスが管理者かチェック
   - 管理画面の各ルートで権限チェック

2. **管理者管理API**
   - `GET /admin/users`: 管理者一覧取得
   - `POST /admin/users`: 新規管理者追加
   - `PUT /admin/users/<id>`: 管理者情報更新
   - `DELETE /admin/users/<id>`: 管理者削除

3. **フロントエンド**
   - 管理画面に「管理者管理」タブ追加
   - 管理者一覧表示
   - 管理者追加フォーム
   - 管理者削除確認ダイアログ

### 成功基準
- [ ] .envのADMIN_EMAILが初期管理者として自動設定される
- [ ] 管理者は管理画面にアクセスできる
- [ ] 一般ユーザーは管理画面にアクセスできない
- [ ] 管理者は新しい管理者を最大5人まで追加できる
- [ ] 管理者権限の有効/無効を切り替えできる
- [ ] 管理者を削除できる
- [ ] 管理者の追加/削除履歴が記録される

### セキュリティ考慮事項
- [ ] 管理者権限のないユーザーは管理画面にアクセス不可
- [ ] 管理者の最大数制限（6人まで：初期1人+追加5人）
- [ ] 管理者操作のログ記録
- [ ] セッション管理との連携

## 実装順序

### Phase 1: 基盤機能
1. 権限チェック関数の実装
2. 管理画面への権限制御追加
3. 初期管理者の自動設定機能

### Phase 2: 管理機能
1. 管理者管理APIの実装
2. 管理画面UIの実装
3. 管理者追加/削除機能

### Phase 3: セキュリティ強化
1. 操作ログの記録
2. エラーハンドリング
3. テストケースの作成

## 影響範囲
- `app.py`: 権限チェック機能追加
- `database/models.py`: 管理者関連関数追加
- `templates/admin.html`: 管理者管理UI追加
- `static/js/admin.js`: 管理者管理機能追加

## 注意事項
- 管理者権限の削除は慎重に実装（最後の管理者を削除できないようにする）
- .envのADMIN_EMAILが変更された場合の対応を検討
- 管理者権限の監査ログは必須

## 関連チケット
- 既存の管理画面機能との統合
- セッション管理機能との連携

## 完了予定日
2025-07-30

## ステータス
- [x] 要件定義完了
- [ ] 実装開始
- [ ] テスト実施
- [ ] 完了